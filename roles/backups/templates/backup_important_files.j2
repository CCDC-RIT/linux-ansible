#!/bin/bash
set -euo pipefail

if [[ $EUID != 0 ]]; then
    echo "Please run this script as root!"
    exit 1
fi

FILES=(
  docker-compose.yml
  docker-compose.yaml
  compose.yml
  compose.yaml
  Makefile
  Dockerfile
  .dockerignore
  .env
  kubeconfig
  nginx.conf
  apache2.conf
  httpd.conf
  crontab
  id_rsa
  id_ed25519
  authorized_keys
  known_hosts
  config
  credentials
  config.php
  config.json
  config.yaml
  config.yml
  config.toml
  config.ini
  settings.py
  secrets.yml
  secrets.yaml
  vault.hcl
  *.htm
  *.html
  *.php
  *.pem
  *.key
  *.crt
  *.cer
)

HOME_EXTS=(
  *.txt
  *.pdf
  *.doc
  *.docx
  *.xlsx
  *.json
  *.xml
  *.toml
  *.sh
  *.py
  *.js
  *.pl
  *.md
  *.csv
  *.png
  *.jpg
  *.log
  *.zip
  *.7z
)

BACKUP_DIR="{{ backup_dir }}"

mkdir -p "$BACKUP_DIR/sus_files"

touch "$BACKUP_DIR/sus_files/log.txt"

backup_file() {
  local file="$1"
  echo "Backing up: $file" >> "$BACKUP_DIR/sus_files/log.txt"
  cp --parents -a "$file" "$BACKUP_DIR" 2>/dev/null || true
}

for name in "${HOME_EXTS[@]}"; do
  find / \
    -path /proc -prune -o \
    -path /sys -prune -o \
    -path /dev -prune -o \
    -path /run -prune -o \
    -path /tmp -prune -o \
    -path /var/cache -prune -o \
    -type f -iname "$name" -print |
    while read -r file; do
        backup_file "$file"
    done
done

for name in "${FILES[@]}"; do
  find /home \
    -type f -iname "$name" -print |
    while read -r file; do
        backup_file "$file"
    done
done