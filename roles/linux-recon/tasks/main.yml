---
# PHASE 0 - Setup
- name: Ensure nmap is installed
  ansible.builtin.package:
    name: nmap
    state: present
  become: true

# TODO: add creds for diff boxes in the topo. define a list of usernames and password combos and try them against all 

# PHASE 1 â€” Discover live hosts
- name: Discover live hosts on subnet (ping)
  ansible.builtin.command: >
    nmap -sn {{ subnet }} -oG -
  register: ping_scan

- name: Show live hosts from ping scan
  ansible.builtin.debug:
    var: ping_scan.stdout_lines

- name: Discover live hosts on subnet (SSH)
  ansible.builtin.command: >
    nmap -p 22 --open -Pn {{ subnet }} -oG -
  register: ssh_scan

- name: Show live hosts from SSH scan
  ansible.builtin.debug:
    var: ssh_scan.stdout_lines

# create a union of both scan results to get all live hosts
- name: Get IPs of live hosts from both scans
  ansible.builtin.set_fact:
    combined_live_hosts: >
      {{(ping_scan.stdout_lines + ssh_scan.stdout_lines) | map('regex_search', '^Host: (\\S+)', '\\1') | list}}

# - name: Extract discovered IPs
#   ansible.builtin.set_fact:
#     discovered_ips: # awk '{print $2}' to get IP from nmap grepable output
#       "{{ (ping_scan.stdout_lines + ssh_scan.stdout_lines)
#         | select('search', '^Host:')
#         | map('regex_search', '^Host: (\\S+)', '\\1')
#         | list }}"

- name: Output discovered IPs
  ansible.builtin.debug:
    var: discovered_ips

- name: Write IP list
  ansible.builtin.copy:
    dest: "/opt/linuxrecon/discovered_ips.txt"
    content: |
      {% for ip in discovered_ips %}
      {{ ip }}
      {% endfor %}
  delegate_to: localhost
  run_once: true

# PHASE 2 - Scan hosts
- name: Scan hosts for OS, hostname, and ports
  ansible.builtin.command: >
    nmap -O -sT -Pn {{ item }}
  loop: "{{ discovered_ips }}"
  register: scan_results
  changed_when: false

# PHASE 3 - Save results to file
- name: Create CSV header
  ansible.builtin.copy:
    dest: "{{ output_file }}"
    content: "ip address,hostname,operating system,ports\n"

- name: Append scan results to file
  ansible.builtin.lineinfile:
    path: "{{ output_file }}"

# PHASE 4 - Gather specific facts from each host
- name: Add discovered hosts to inventory group
  ansible.builtin.add_host:
    name: "{{ item }}"
    groups: discovered_hosts
  loop: "{{ discovered_ips }}"

- name: Gather system facts using Ansible facts
  ansible.builtin.setup:
    gather_subset:
      - network
      - hardware
      - virtual
      - distribution
  delegate_to: "{{ inventory_hostname }}"
  become: true
  run_once: false
  when: inventory_hostname in groups['discovered_hosts']

- name: Get local users
  ansible.builtin.command: getent passwd
  register: passwd_output
  changed_when: false

# - name: Get all listening TCP/UDP ports
#   ansible.builtin.command: ss -tulpen
#   register: listening_ports
#   changed_when: false

- name: Gather listening ports
  community.general.listen_ports_facts: # will use first found supported command on the system (ss or netstat)
    # include_non_listening: true

- name: List TCP ports
  ansible.builtin.debug:
    msg: "{{ ansible_facts.tcp_listen | map(attribute='port') | sort | list }}"

- name: List UDP ports
  ansible.builtin.debug:
    msg: "{{ ansible_facts.udp_listen | map(attribute='port') | sort | list }}"

- name: Debug netstat TCP listen
  ansible.builtin.debug:
    var: ansible_netstat.tcp_listen

- name: Build host profile
  ansible.builtin.set_fact:
    host_profile:
      ip: "{{ ansible_host | default(inventory_hostname) }}"
      hostname: "{{ ansible_facts.hostname }}"
      fqdn: "{{ ansible_facts.fqdn | default('unknown') }}"
      domain: "{{ ansible_facts.domain | default('unknown') }}"
      os: "{{ ansible_facts.distribution }}"
      os_version: "{{ ansible_facts.distribution_version }}"
      os_release: "{{ ansible_facts.distribution_release }}"
      mac_addresses: >-
        {{
          ansible_facts.interfaces
          | map('extract', ansible_facts)
          | selectattr('macaddress', 'defined')
          | map(attribute='macaddress')
          | list
        }}
      users: "{{ local_users | default([]) }}"
      listening_ports: "{{ listening_ports.stdout_lines }}"

# TODO: save all info to CSV

# - name: Save host profile JSON on control node
#   ansible.builtin.copy:
#     dest: "{{ control_output_dir }}/{{ inventory_hostname }}.json"
#     content: "{{ host_profile | to_nice_json }}"
#     mode: '0644'
#   delegate_to: localhost
#   become: false

# - name: Get service using nmap
#   command: nmap -sT -sV -p- localhost | sed -n '6 p' | awk '{ print $3 }'
#   register: nmap_service

# - name: Get port using nmap
#   shell: nmap -sT -sV -p- localhost | sed -n '6 p' | awk -F/ '{ print $1 }'
#   register: nmap_port

# - name: Save nmap results as custom facts
#   copy:
#     dest: "/etc/ansible/facts.d/nmap_results.fact"
#     content: |
#       {
#         "nmap_service": "{{ nmap_service.stdout }}",
#         "nmap_port": "{{ nmap_port.stdout }}"
#       }
#   delegate_to: localhost