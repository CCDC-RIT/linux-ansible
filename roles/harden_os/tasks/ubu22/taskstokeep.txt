- name: "1.5.1 | PATCH | Ensure address space layout randomization is enabled | set active kernel parameter"
  ansible.posix.sysctl:
    name: kernel.randomize_va_space
    value: '2'
    state: present
    sysctl_file: /etc/sysctl.d/98_kernel.conf
    reload: true
    sysctl_set: true
    ignoreerrors: true
  when: rule_1_5_1

- name: "1.5.2 | PATCH | Ensure ptrace_scope is restricted"
  ansible.posix.sysctl:
    name: kernel.yama.ptrace_scope
    value: '1'
    state: present
    sysctl_file: /etc/sysctl.d/98_kernel.conf
    reload: true
    sysctl_set: true
    ignoreerrors: true
  when: rule_1_5_2

- name: "1.5.3 | PATCH | Ensure core dumps are restricted"
  block:
    - name: "1.5.3 | kernel sysctl"
      ansible.posix.sysctl:
        name: fs.suid_dumpable
        value: '0'
        state: present
        sysctl_file: /etc/sysctl.d/98_kernel.conf
        reload: true
        sysctl_set: true
        ignoreerrors: true

    - name: "1.5.3 | security limits"
      ansible.builtin.lineinfile:
        path: /etc/security/limits.d/99_zero_core.conf
        regexp: '^\* hard core'
        line: '* hard core 0'
        create: true
        owner: root
        group: root
        mode: 'go-wx'

    - name: "1.5.3 | sysctl.conf"
      ansible.builtin.lineinfile:
        path: /etc/sysctl.conf
        regexp: '^fs.suid_dumpable'
        line: fs.suid_dumpable=0
        owner: root
        group: root
        mode: 'go-wx'

    - name: "1.5.3 | coredump.conf"
      ansible.builtin.lineinfile:
        path: /etc/systemd/coredump.conf
        regexp: "{{ item.regexp }}"
        line: "{{ item.line }}"
        create: true
        owner: root
        group: root
        mode: 'go-wx'
      loop:
        - { regexp: '^Storage', line: 'Storage=none' }
        - { regexp: '^ProcessSizeMax', line: 'ProcessSizeMax=0' }
  when: rule_1_5_3

- name: "1.5.4 | PATCH | Ensure prelink is not installed"
  block:
    - name: "1.5.4 | restore binaries to normal"
      ansible.builtin.command: prelink -ua
      changed_when: false
      failed_when: false

    - name: "1.5.4 | remove prelink package"
      ansible.builtin.package:
        name: prelink
        state: absent
        purge: false
  when:
    - rule_1_5_4

- name: "1.5.5 | PATCH | Ensure Automatic Error Reporting is not enabled"
  block:
    - name: "1.5.5 | diable"
      ansible.builtin.lineinfile:
        path: /etc/default/apport
        regexp: ^enabled
        line: enabled=0
        create: true
        owner: root
        group: root
        mode: 'go-wx'

    - name: "1.5.5 | remove package"
      ansible.builtin.package:
        name: apport
        state: absent
        purge: false
      when: "'apport' in ansible_facts.packages"
  when: rule_1_5_5

- name: "1.6.1 | PATCH | Ensure message of the day is configured properly"
  block:
    - name: "1.6.1 | motd"
      ansible.builtin.template:
        src: "{{ ansible_dir }}/ubu22/templates/etc/motd.j2"
        dest: /etc/motd
        owner: root
        group: root
        mode: 'u-x,go-wx'

    - name: "1.6.1 | disable dynamic_motd"
      ansible.builtin.lineinfile:
        path: /etc/pam.d/sshd
        regexp: "{{ item.regexp }}"
        line: "{{ item.line }}"
        backrefs: true
      loop:
        - { regexp: '(session\s+optional\s+pam_motd.so\s+motd=/run/motd.dynamic)', line: '# \1' }
        - { regexp: '(session\s+optional\s+pam_motd.so noupdate)', line: '# \1' }
        - { regexp: '# Pam_motd.so disabled for CIS benchmark', line: '# Pam_motd.so disabled for CIS benchmark' }
  when: rule_1_6_1

TODO: change this to our own message
- name: "1.6.2 | PATCH | Ensure local login warning banner is configured properly"
  block:
    - name: "1.6.2 | issue"
      ansible.builtin.template:
        src: "{{ ansible_dir }}/ubu22/templates/etc/issue.j2"
        dest: /etc/issue
        owner: root
        group: root
        mode: 'u-x,go-wx'

    - name: "1.6.2 | issue"
      community.general.dpkg_divert:
        path: /etc/issue
  when: rule_1_6_2

- name: "1.6.3 | PATCH | Ensure remote login warning banner is configured properly"
  block:
    - name: "1.6.3 | issue.net"
      ansible.builtin.template:
        src: "{{ ansible_dir }}/ubu22/templates/etc/issue.net.j2"
        dest: /etc/issue.net
        owner: root
        group: root
        mode: 'u-x,go-wx'

    - name: "1.6.3 | issue.net"
      community.general.dpkg_divert:
        path: /etc/issue.net
  when: rule_1_6_3


- name: "1.6.4 | PATCH | Ensure access to /etc/motd is configured"
  ansible.builtin.file:
    path: /etc/motd
    owner: root
    group: root
    mode: 'u-x,go-wx'
  when: rule_1_6_4

- name: "1.6.5 | PATCH | Ensure access to /etc/issue is configured"
  ansible.builtin.file:
    path: /etc/issue
    owner: root
    group: root
    mode: 'u-x,go-wx'
  when: rule_1_6_5

- name: "1.6.6 | PATCH | Ensure access to /etc/issue.net is configured"
  ansible.builtin.file:
    path: /etc/issue.net
    owner: root
    group: root
    mode: 'u-x,go-wx'
  when: rule_1_6_6

---

- name: "1.7.1 | PATCH | Ensure GDM is removed"
  ansible.builtin.package:
    name: gdm3
    state: absent
  when:
    - rule_1_7_1
    - disruption_high
    - not desktop_required
    - "'gdm3' in ansible_facts.packages"

- name: "1.7.2 | PATCH | Ensure GDM login banner is configured"
  block:
    - name: "1.7.2 | make directory"
      ansible.builtin.file:
        path: "/etc/dconf/db/{{ prelim_dconf_system_db.stdout }}.d"
        owner: root
        group: root
        mode: 'go-w'
        state: directory

    - name: "1.7.2 | banner settings"
      ansible.builtin.lineinfile:  # noqa: args[module]
        path: "/etc/dconf/db/{{ prelim_dconf_system_db.stdout }}.d/00-login-screen"
        regexp: "{{ item.regexp }}"
        line: "{{ item.line }}"
        insertafter: "{{ item.insertafter }}"
        create: true
        owner: root
        group: root
        mode: 'u-x,go-wx'
      loop:
        - { regexp: "\\[org\\/gnome\\/login-screen\\]", line: "[org/gnome/login-screen]", insertafter: EOF }
        - { regexp: "banner-message-enable", line: "banner-message-enable=true", insertafter: "\\[org\\/gnome\\/login-screen\\]" }
        - { regexp: "banner-message-text", line: "banner-message-text='{{ warning_banner | regex_replace('\n', ' ') | trim }}'", insertafter: "banner-message-enable" }
  when:
    - rule_1_7_2
    - desktop_required
  ignore_errors: yes

- name: "1.7.3 | PATCH | Ensure GDM disable-user-list option is enabled"
  block:
    - name: "1.7.3 | make directories"
      ansible.builtin.file:
        path: "{{ item }}"
        owner: root
        group: root
        mode: 'go-w'
        state: directory
      loop:
        - /etc/dconf/db/{{ prelim_dconf_system_db.stdout }}.d
        - /etc/dconf/profile

    - name: "1.7.3 | disable-user-list setting login-screen"
      ansible.builtin.lineinfile:
        path: "/etc/dconf/db/{{ prelim_dconf_system_db.stdout }}.d/00-login-screen"
        regexp: "{{ item.regexp }}"
        line: "{{ item.line }}"
        insertafter: "{{ item.insertafter }}"
        create: true
        owner: root
        group: root
        mode: 'u-x,go-wx'
      loop:
        - { regexp: "\\[org\\/gnome\\/login-screen\\]", line: "[org/gnome/login-screen]", insertafter: EOF }
        - { regexp: "disable-user-list", line: "disable-user-list=true", insertafter: "\\[org\\/gnome\\/login-screen\\]" }

    - name: "1.7.3 | disable-user-list setting profile"
      ansible.builtin.lineinfile:
        path: "/etc/dconf/profile/{{ prelim_dconf_system_db.stdout }}"
        regexp: "{{ item.regexp }}"
        line: "{{ item.line }}"
        insertafter: "{{ item.insertafter }}"
        create: true
        owner: root
        group: root
        mode: 'u-x,go-wx'
      loop:
        - { regexp: "^user-db:user", line: "user-db:user", insertafter: EOF }
        - { regexp: "^system-db:{{ prelim_dconf_system_db.stdout }}", line: "system-db:{{ prelim_dconf_system_db.stdout }}", insertafter: "user-db:user" }
        - regexp: "^file-db:/usr/share/gdm/greeter-dconf-defaults"
          line: "file-db:/usr/share/gdm/greeter-dconf-defaults"
          insertafter: "system-db:{{ prelim_dconf_system_db.stdout }}"
  when:
    - rule_1_7_3
    - desktop_required
    - not prelim_dconf_system_db | length == 0
  ignore_errors: yes

- name: "1.7.4 | PATCH | Ensure GDM screen locks when the user is idle"
  block:
    - name: "1.7.4 | session profile"
      ansible.builtin.lineinfile:
        path: "/etc/dconf/profile/{{ prelim_dconf_system_db.stdout }}"
        regexp: "{{ item.regexp }}"
        line: "{{ item.line }}"
        insertafter: "{{ item.after | default(omit) }}"
        create: true
        owner: root
        group: root
        mode: 'u-x,go-wx'
      loop:
        - { regexp: "user-db:user", line: "user-db:user" }
        - { regexp: "system-db:{{ prelim_dconf_system_db.stdout }}", line: "system-db:{{ prelim_dconf_system_db.stdout }}", after: "^user-db.*" }

    - name: "1.7.4 | make directory"
      ansible.builtin.file:
        path: "/etc/dconf/db/{{ prelim_dconf_system_db.stdout }}.d"
        owner: root
        group: root
        mode: 'go-w'
        state: directory

    - name: "1.7.4 | session script"
      ansible.builtin.template:
        src: "{{ ansible_dir }}/ubu22/templates/etc/dconf/db/00-screensaver.j2"
        dest: "/etc/dconf/db/{{ prelim_dconf_system_db.stdout }}.d/00-screensaver"
        owner: root
        group: root
        mode: 'u-x,go-wx'
  when:
    - rule_1_7_4
    - desktop_required
  ignore_errors: yes

- name: "1.7.5 | PATCH | Ensure GDM screen locks cannot be overridden"
  block:
    - name: "1.7.5 | make lock directory"
      ansible.builtin.file:
        path: "/etc/dconf/db/{{ prelim_dconf_system_db.stdout }}.d/locks"
        owner: root
        group: root
        mode: 'go-w'
        state: directory

    - name: "1.7.5 | make lockfile"
      ansible.builtin.template:
        src: "{{ ansible_dir }}/ubu22/templates/etc/dconf/db/00-screensaver_lock.j2"
        dest: "/etc/dconf/db/{{ prelim_dconf_system_db.stdout }}.d/locks/00-screensaver"
        owner: root
        group: root
        mode: 'u-x,go-wx'
  when:
    - rule_1_7_5
    - desktop_required
  ignore_errors: yes

- name: "1.7.6 | PATCH | Ensure GDM automatic mounting of removable media is disabled"
  block:
    - name: "1.7.6 | make directory"
      ansible.builtin.file:
        path: "/etc/dconf/db/{{ prelim_dconf_system_db.stdout }}.d"
        owner: root
        group: root
        mode: 'go-w'
        state: directory

    - name: "1.7.6 | session script"
      ansible.builtin.template:
        src: "{{ ansible_dir }}/ubu22/templates/etc/dconf/db/00-media-automount.j2"
        dest: "/etc/dconf/db/{{ prelim_dconf_system_db.stdout }}.d/00-media-automount"
        owner: root
        group: root
        mode: 'u-x,go-wx'
  when:
    - rule_1_7_6
    - desktop_required
  ignore_errors: yes

- name: "1.7.7 | PATCH | Ensure GDM disabling automatic mounting of removable media is not overridden"
  block:
    - name: "1.7.7 | make lock directory"
      ansible.builtin.file:
        path: "/etc/dconf/db/{{ prelim_dconf_system_db.stdout }}.d/locks"
        owner: root
        group: root
        mode: 'go-w'
        state: directory

    - name: "1.7.7 | make lockfile"
      ansible.builtin.template:
        src: "{{ ansible_dir }}/ubu22/templates/etc/dconf/db/00-automount_lock.j2"
        dest: "/etc/dconf/db/{{ prelim_dconf_system_db.stdout }}.d/locks/00-automount_lock"
        owner: root
        group: root
        mode: 'u-x,go-wx'
  when:
    - rule_1_7_7
    - desktop_required
  ignore_errors: yes

- name: "1.7.8 | PATCH | Ensure GDM autorun-never is enabled"
  block:
    - name: "1.7.8 | make directory"
      ansible.builtin.file:
        path: "/etc/dconf/db/{{ prelim_dconf_system_db.stdout }}.d"
        owner: root
        group: root
        mode: 'go-w'
        state: directory

    - name: "1.7.8 | session script"
      ansible.builtin.template:
        src: "{{ ansible_dir }}/ubu22/templates/etc/dconf/db/00-media-autorun.j2"
        dest: "/etc/dconf/db/{{ prelim_dconf_system_db.stdout }}.d/00-media-autorun"
        owner: root
        group: root
        mode: 'u-x,go-wx'
  when:
    - rule_1_7_8
    - desktop_required
  ignore_errors: yes

- name: "1.7.9 | PATCH | Ensure GDM autorun-never is not overridden"
  block:
    - name: "1.7.9 | make lock directory"
      ansible.builtin.file:
        path: "/etc/dconf/db/{{ prelim_dconf_system_db.stdout }}.d/locks"
        owner: root
        group: root
        mode: 'go-w'
        state: directory

    - name: "1.7.9 | make lockfile"
      ansible.builtin.template:
        src: "{{ ansible_dir }}/ubu22/templates/etc/dconf/db/00-autorun_lock.j2"
        dest: "/etc/dconf/db/{{ prelim_dconf_system_db.stdout }}.d/locks/00-autorun_lock"
        owner: root
        group: root
        mode: 'u-x,go-wx'
  when:
    - rule_1_7_9
    - desktop_required
  ignore_errors: yes

- name: "1.7.10 | PATCH | Ensure XDCMP is not enabled"
  ansible.builtin.lineinfile:
    path: /etc/gdm3/custom.conf
    regexp: "^Enable.*=.*true"
    state: absent
  when:
    - rule_1_7_10
    - desktop_required
  ignore_errors: yes

---

- name: "3.1.1 | PATCH | Ensure IPv6 status is identified"
  block:
    - name: "3.1.1 | Replace ipv6.disable if it exists"
      ansible.builtin.replace:
        path: /etc/default/grub
        regexp: '^(GRUB_CMDLINE_LINUX=.*)\bipv6\.disable=\d\b(.*$)'
        replace: '\1ipv6.disable=1\2'
      register: discovered_ipv6disable_replaced
      when: ipv6_disable == 'grub'

    - name: "3.1.1 | Check grub cmdline linux"
      ansible.builtin.shell: grep "GRUB_CMDLINE_LINUX=" /etc/default/grub | cut -f2 -d'"'
      changed_when: false
      failed_when: false
      check_mode: false
      register: discovered_grub_cmdline_settings

    - name: "3.1.1 | Insert ipv6.disable if it doesn't exist"
      ansible.builtin.lineinfile:
        path: /etc/default/grub
        regexp: '^(GRUB_CMDLINE_LINUX=".*)"$'
        line: '\1 ipv6.disable=1"'
        backrefs: true
      when:
        - ipv6_disable == 'grub'
        - discovered_ipv6disable_replaced is not changed
        - "'ipv6.disable' not in discovered_grub_cmdline_settings.stdout"

    - name: "3.1.1 | Remove net.ipv6.conf.all.disable_ipv6"
      ansible.builtin.template:
        src: "{{ ansible_dir }}/ubu22/templates/{{ item }}.j2"
        dest: "/{{ item }}"
        owner: root
        group: root
        mode: 'g-wx,o-rwx'
      loop:
        - etc/sysctl.d/60-disable_ipv6.conf
      when: ipv6_disable == 'sysctl'
  when:
    - rule_3_1_1
    - not ipv6_required

- name: "3.1.2 | PATCH | Ensure wireless interfaces are disabled"
  block:
    - name: "3.1.2 | Check for network-manager tool"
      ansible.builtin.command: nmcli radio wifi
      changed_when: false
      failed_when: false
      check_mode: false
      register: discovered_wifi_status
      when: "'network-manager' in ansible_facts.packages"

    - name: "3.1.2 | Disable wireless if network-manager installed"
      ansible.builtin.command: nmcli radio all off
      changed_when: discovered_nmcli_radio_off.rc == 0
      register: discovered_nmcli_radio_off
      when:
        - "'network-manager' in ansible_facts.packages"
        - "'enabled' in discovered_wifi_status.stdout"

    - name: "3.1.2 | Warn about wireless if network-manager not installed"
      ansible.builtin.debug:
        msg: "Warning!! You need to disable wireless interfaces manually since network-manager is not installed"
      when: "'network-manager' not in ansible_facts.packages"
  when:
    - rule_3_1_2
    - prelim_wireless_adapters_exist

- name: "3.1.3 | PATCH | Ensure bluetooth services are not in use"
  ansible.builtin.package:
    name: bluez
    state: absent
  when: rule_3_1_3


[[[TODO: consolidate]]]
---

- name: "3.2.1 | PATCH | Ensure dccp kernel module is not available"
  block:
    - name: "3.2.1 | modprobe"
      ansible.builtin.lineinfile:
        path: /etc/modprobe.d/dccp.conf
        regexp: '^(#)?install dccp(\\s|$)'
        line: "{{ item }}"
        create: true
        owner: root
        group: root
        mode: 'go-wx'
      loop:
        - install dccp /bin/true
        - blacklist dccp

    - name: "3.2.1 | PATCH | Ensure dccp kernel module is not available | blacklist"
      ansible.builtin.lineinfile:
        path: /etc/modprobe.d/blacklist.conf
        regexp: "^(#)?blacklist cramfs(\\s|$)"
        line: "blacklist cramfs"
        create: true
        mode: 'go-wx'
  when: rule_3_2_1

- name: "3.2.2 | PATCH | Ensure tipc kernel module is not available"
  block:
    - name: "3.2.2 | modprobe"
      ansible.builtin.lineinfile:
        path: /etc/modprobe.d/tipc.conf
        regexp: '^(#)?install tipc(\\s|$)'
        line: "{{ item }}"
        create: true
        owner: root
        group: root
        mode: 'go-wx'
      loop:
        - install tipc /bin/true
        - blacklist tipc

    - name: "3.2.2 | blacklist"
      ansible.builtin.lineinfile:
        path: /etc/modprobe.d/blacklist.conf
        regexp: "^(#)?blacklist tipc(\\s|$)"
        line: "blacklist tipc"
        create: true
        mode: 'go-wx'
  when: rule_3_2_2

- name: "3.2.3 | PATCH | Ensure rds kernel module is not available"
  block:
    - name: "3.2.3 | modprobe"
      ansible.builtin.lineinfile:
        path: /etc/modprobe.d/rds.conf
        regexp: '^(#)?install rds(\\s|$)'
        line: "{{ item }}"
        create: true
        owner: root
        group: root
        mode: 'go-wx'
      loop:
        - install rds /bin/true
        - blacklist rds

    - name: "3.2.3 | PATCH | Ensure rds kernel module is not available | blacklist"
      ansible.builtin.lineinfile:
        path: /etc/modprobe.d/blacklist.conf
        regexp: "^(#)?blacklist rds(\\s|$)"
        line: "blacklist rds"
        create: true
        mode: 'go-wx'
  when: rule_3_2_3

- name: "3.2.4 | PATCH | Ensure sctp kernel module is not available"
  block:
    - name: "3.2.4 | modprobe"
      ansible.builtin.lineinfile:
        path: /etc/modprobe.d/sctp.conf
        regexp: '^(#)?install sctp(\\s|$)'
        line: "{{ item }}"
        create: true
        owner: root
        group: root
        mode: 'go-wx'
      loop:
        - install sctp /bin/true
        - blacklist sctp

    - name: "3.2.4 | blacklist"
      ansible.builtin.lineinfile:
        path: /etc/modprobe.d/blacklist.conf
        regexp: "^(#)?blacklist sctp(\\s|$)"
        line: "blacklist sctp"
        create: true
        owner: root
        group: root
        mode: 'go-wx'
  when: rule_3_2_4
[[[TODO: consolidate]]]


[[[TODO: turn this into a jinja template or file to copy over instead]]]
---

- name: "3.3.1 | PATCH | Ensure IP forwarding is disabled"
  block:
    - name: "3.3.1 | IPv4 settings"
      ansible.posix.sysctl:
        name: net.ipv4.ip_forward
        value: '0'
        sysctl_set: true
        sysctl_file: /etc/sysctl.conf
        state: present
        reload: true
        ignoreerrors: true

    - name: "3.3.1 | IPv6 settings"
      ansible.posix.sysctl:
        name: net.ipv6.conf.all.forwarding
        value: '0'
        sysctl_set: true
        sysctl_file: /etc/sysctl.conf
        state: present
        reload: true
        ignoreerrors: true
      when: ipv6_disable == 'sysctl'
  when: rule_3_3_1

- name: "3.3.2 | PATCH | Ensure packet redirect sending is disabled"
  ansible.posix.sysctl:
    name: "{{ item }}"
    value: '0'
    sysctl_set: true
    sysctl_file: /etc/sysctl.conf
    state: present
    reload: true
    ignoreerrors: true
  loop:
    - net.ipv4.conf.all.send_redirects
    - net.ipv4.conf.default.send_redirects
  when: rule_3_3_2

- name: "3.3.3 | PATCH | Ensure bogus ICMP responses are ignored"
  ansible.posix.sysctl:
    name: net.ipv4.icmp_ignore_bogus_error_responses
    value: '1'
    sysctl_set: true
    sysctl_file: /etc/sysctl.conf
    state: present
    reload: true
    ignoreerrors: true
  when: rule_3_3_3

- name: "3.3.4 | PATCH | Ensure broadcast ICMP requests are ignored"
  ansible.posix.sysctl:
    name: net.ipv4.icmp_echo_ignore_broadcasts
    value: '1'
    sysctl_set: true
    sysctl_file: /etc/sysctl.conf
    state: present
    reload: true
    ignoreerrors: true
  when: rule_3_3_4

- name: "3.3.5 | PATCH | Ensure ICMP redirects are not accepted"
  block:
    - name: "3.3.5 | IPv4 settings"
      ansible.posix.sysctl:
        name: "{{ item }}"
        value: '0'
        sysctl_set: true
        sysctl_file: /etc/sysctl.conf
        state: present
        reload: true
        ignoreerrors: true
      loop:
        - net.ipv4.conf.all.accept_redirects
        - net.ipv4.conf.default.accept_redirects

    - name: "3.3.5 | IPv6 settings"
      ansible.posix.sysctl:
        name: "{{ item }}"
        value: '0'
        sysctl_set: true
        sysctl_file: /etc/sysctl.conf
        state: present
        reload: true
        ignoreerrors: true
      loop:
        - net.ipv6.conf.all.accept_redirects
        - net.ipv6.conf.default.accept_redirects
      when: ipv6_disable == 'sysctl'
  when: rule_3_3_5

- name: "3.3.6 | PATCH | Ensure secure ICMP redirects are not accepted"
  ansible.posix.sysctl:
    name: "{{ item }}"
    value: '0'
    sysctl_set: true
    sysctl_file: /etc/sysctl.conf
    state: present
    reload: true
    ignoreerrors: true
  loop:
    - net.ipv4.conf.all.secure_redirects
    - net.ipv4.conf.default.secure_redirects
  when: rule_3_3_6

- name: "3.3.7 | PATCH | Ensure Reverse Path Filtering is enabled"
  ansible.posix.sysctl:
    name: "{{ item }}"
    value: '1'
    sysctl_set: true
    sysctl_file: /etc/sysctl.conf
    state: present
    reload: true
    ignoreerrors: true
  loop:
    - net.ipv4.conf.all.rp_filter
    - net.ipv4.conf.default.rp_filter
  when: rule_3_3_7

- name: "3.3.8 | PATCH | Ensure source routed packets are not accepted"
  block:
    - name: "3.3.8 | IPv4 settings"
      ansible.posix.sysctl:
        name: "{{ item }}"
        value: '0'
        sysctl_set: true
        sysctl_file: /etc/sysctl.conf
        state: present
        reload: true
        ignoreerrors: true
      loop:
        - net.ipv4.conf.all.accept_source_route
        - net.ipv4.conf.default.accept_source_route

    - name: "3.3.8 | IPv6 settings"
      ansible.posix.sysctl:
        name: "{{ item }}"
        value: '0'
        sysctl_set: true
        sysctl_file: /etc/sysctl.conf
        state: present
        reload: true
        ignoreerrors: true
      loop:
        - net.ipv6.conf.all.accept_source_route
        - net.ipv6.conf.default.accept_source_route
      when: ipv6_disable == 'sysctl'
  when: rule_3_3_8

- name: "3.3.9 | PATCH | Ensure suspicious packets are logged"
  ansible.posix.sysctl:
    name: "{{ item }}"
    value: '1'
    sysctl_set: true
    sysctl_file: /etc/sysctl.conf
    state: present
    reload: true
    ignoreerrors: true
  loop:
    - net.ipv4.conf.all.log_martians
    - net.ipv4.conf.default.log_martians
  when: rule_3_3_9

- name: "3.3.10 | PATCH | Ensure tcp syn cookies is enabled"
  ansible.posix.sysctl:
    name: net.ipv4.tcp_syncookies
    value: '1'
    sysctl_set: true
    sysctl_file: /etc/sysctl.conf
    state: present
    reload: true
    ignoreerrors: true
  when: rule_3_3_10

- name: "3.3.11 | PATCH | Ensure IPv6 router advertisements are not accepted"
  ansible.posix.sysctl:
    name: "{{ item }}"
    value: '0'
    sysctl_set: true
    sysctl_file: /etc/sysctl.conf
    state: present
    reload: true
    ignoreerrors: true
  loop:
    - net.ipv6.conf.all.accept_ra
    - net.ipv6.conf.default.accept_ra
  when:
    - rule_3_3_11
    - ipv6_required
[[[TODO: turn this into a jinja template or file to copy over instead]]]

[[[TODO: consolidate into a sudoers file template]]]
- name: "5.2.2 | PATCH | Ensure sudo commands use pty"
  ansible.builtin.lineinfile:
    path: /etc/sudoers
    regexp: '^Defaults\s+use_'
    line: 'Defaults        use_pty'
    insertafter: '^\s*Defaults'
  when: rule_5_2_2

- name: "5.2.3 | PATCH | Ensure sudo log file exists"
  ansible.builtin.lineinfile:
    path: /etc/sudoers
    regexp: '^Defaults\s+logfile'
    line: 'Defaults        logfile=/var/log/sudo.log'
    insertafter: '^\s*Defaults'
  when: rule_5_2_3

- name: "5.2.4 | PATCH | Ensure users must provide password for privilege escalation"
  ansible.builtin.replace:
    path: "{{ item }}"
    regexp: '^([^#|{% if system_is_ec2 %}ec2-user{% endif %}].*)NOPASSWD(.*)'
    replace: '\1PASSWD\2'
    validate: '/usr/sbin/visudo -cf %s'
  loop: "{{ prelim_sudoers_files.stdout_lines }}"
  when: rule_5_2_4

- name: "5.2.5 | PATCH | Ensure re-authentication for privilege escalation is not disabled globally"
  ansible.builtin.replace:
    path: "{{ item }}"
    regexp: '^([^#].*)!authenticate(.*)'
    replace: '\1authenticate\2'
    validate: '/usr/sbin/visudo -cf %s'
  loop: "{{ prelim_sudoers_files.stdout_lines }}"
  when: rule_5_2_5

- name: "5.2.6 | PATCH | Ensure sudo authentication timeout is configured correctly"
  block:
    - name: "5.2.6 | Get files with timeout set"
      ansible.builtin.shell: grep -is 'timestamp_timeout' /etc/sudoers /etc/sudoers.d/* | cut -d":" -f1 | uniq | sort
      changed_when: false
      failed_when: false
      register: discovered_timeout_files

    - name: "5.2.6 | Set value if no results"
      ansible.builtin.lineinfile:
        path: /etc/sudoers
        regexp: '^\s*Defaults/s+timestamp_timeout='
        line: 'Defaults        timestamp_timeout=15'
        insertafter: '^\s*Defaults'
        validate: '/usr/sbin/visudo -cf %s'
      when: discovered_timeout_files.stdout | length == 0

    - name: "5.2.6 | Set value if has results"
      ansible.builtin.replace:
        path: "{{ item }}"
        regexp: 'timestamp_timeout=(\d+)'
        replace: 'timestamp_timeout=15'
        validate: '/usr/sbin/visudo -cf %s'
      loop: "{{ discovered_timeout_files.stdout_lines }}"
      when: discovered_timeout_files.stdout | length > 0
  when: rule_5_2_6
[[[TODO: consolidate into a sudoers file template]]]


[[[under consideration]]]
- name: "5.3.2.1 | PATCH | Ensure pam_unix module is enabled"
  ansible.builtin.template:
    src: '{{ ansible_dir }}/ubu22/templates/usr/share/pam-configs/pam_unix.j2'
    dest: '/usr/share/pam-configs/pam_unix'
    owner: root
    group: root
    mode: 'go-rwx'
  when:
    - rule_5_3_2_1
    - disruption_high
    - pam_auth_unix
    - pam_create_pamunix_file

[[TODO: consolidate PAM shit]]
---



- name: "5.3.2.2 | PATCH | Ensure pam_faillock module is enabled"
  ansible.builtin.template:
    src: '{{ ansible_dir }}/ubu22/templates/usr/share/pam-configs/{{ item }}.j2'
    dest: '/usr/share/pam-configs/{{ item }}'
    owner: root
    group: root
    mode: 'go-rwx'
  loop:
    - faillock
    - faillock_notify
  when:
    - rule_5_3_2_2
    - disruption_high
    - pam_auth_faillock
    - pam_create_faillock_files

- name: "5.3.2.3 | PATCH | Ensure pam_pwquality module is enabled"
  ansible.builtin.template:
    src: '{{ ansible_dir }}/ubu22/templates/usr/share/pam-configs/pwquality.j2'
    dest: '/usr/share/pam-configs/pwquality'
    owner: root
    group: root
    mode: 'go-rwx'
  when:
    - rule_5_3_2_3
    - disruption_high
    - pam_create_pwquality_files

- name: "5.3.2.4 | PATCH | Ensure pam_pwhistory module is enabled"
  ansible.builtin.template:
    src: '{{ ansible_dir }}/ubu22/templates/usr/share/pam-configs/pwhistory.j2'
    dest: '/usr/share/pam-configs/pwhistory'
    owner: root
    group: root
    mode: 'go-rwx'
  when:
    - rule_5_3_2_4
    - disruption_high
    - pam_create_pwhistory_files

- name: "5.3.3.1.1 | PATCH | Ensure password failed attempts lockout is configured"
  block:
    - name: "5.3.3.1.1 | configure faillock.conf"
      ansible.builtin.lineinfile:
        path: /etc/security/faillock.conf
        regexp: '^deny'
        line: 'deny = 3'
        insertafter: '^# end of pam-auth-update config'
        create: true
        owner: root
        group: root
        mode: 'go-wx'

    - name: "5.3.3.1.1 | discover pam config with deny"
      ansible.builtin.shell: grep -Pl -- '\bpam_faillock\.so\h+([^#\n\r]+\h+)?deny\b' /usr/share/pam-configs/*
      changed_when: false
      failed_when: discovered_faillock_deny_files.rc not in [ 0, 1 ]
      register: discovered_faillock_deny_files

    - name: "5.3.3.1.1 | if exists remove deny from faillock line in pam-auth conf files"
      ansible.builtin.replace:
        path: "{{ item }}"
        regexp: '(*.pam_faillock.so\s*)deny\s*=\s*\d+\b(.*)'
        replace: \1\2
      with_fileglob:
        - '/usr/share/pam-configs/*'
        - '/etc/pam.d/*'
      when: discovered_faillock_deny_files.stdout | length > 0
  when: rule_5_3_3_1_1

- name: "5.3.3.1.2 | PATCH | Ensure password unlock time is configured"
  block:
    - name: "5.3.3.1.2 | configure faillock.conf"
      ansible.builtin.lineinfile:
        path: /etc/security/faillock.conf
        regexp: '^unlock_time'
        line: 'unlock_time = 900'
        insertafter: '^# end of pam-auth-update config'
        create: true
        owner: root
        group: root
        mode: 'go-wx'

    - name: "5.3.3.1.2 | discover pam config with unlock_time"
      ansible.builtin.shell: grep -Pl -- '\bpam_faillock\.so\h+([^#\n\r]+\h+)?unlock_time\b' /usr/share/pam-configs/*
      register: discovered_faillock_unlock_files
      changed_when: false
      failed_when: discovered_faillock_unlock_files.rc not in [ 0, 1 ]

    - name: "5.3.3.1.2 | if exists remove unlock_time from faillock line in pam-auth conf files"
      ansible.builtin.replace:
        path: "{{ item }}"
        regexp: '(*.pam_faillock.so\s*)unlock_time\s*=\s*\b(.*)'
        replace: \1\2
      with_fileglob:
        - '/usr/share/pam-configs/*'
        - '/etc/pam.d/*'
      when: discovered_faillock_unlock_files.stdout | length > 0
  when: rule_5_3_3_1_2

- name: "5.3.3.1.3 | PATCH | Ensure password failed attempts lockout includes root account"
  block:
    - name: "5.3.3.1.3 | configure faillock.conf"
      ansible.builtin.lineinfile:
        path: /etc/security/faillock.conf
        regexp: '^even_deny_root'
        line: 'even_deny_root'
        insertafter: '^# end of pam-auth-update config'
        create: true
        owner: root
        group: root
        mode: 'go-wx'

    - name: "5.3.3.1.3 | discover pam config with unlock_time"
      ansible.builtin.shell: grep -Pl -- '\bpam_faillock\.so\h+([^#\n\r]+\h+)?(even_deny_root\b|root_unlock_time\s*=\s*\d+\b)' /usr/share/pam-configs/*
      changed_when: false
      failed_when: discovered_faillock_rootlock_files.rc not in [ 0, 1 ]
      register: discovered_faillock_rootlock_files

    - name: "5.3.3.1.3 | if exists remove unlock_time from faillock line in pam-auth conf files"
      ansible.builtin.replace:
        path: "{{ item }}"
        regexp: '(*.pam_faillock.so\s*)(even_deny_root\b|root_unlock_time\s*=\s*\d+\b)(.*)'
        replace: \1\3
      with_fileglob:
        - '/usr/share/pam-configs/*'
        - '/etc/pam.d/*'
      when: discovered_faillock_rootlock_files.stdout | length > 0
  when: rule_5_3_3_1_3

- name: "5.3.3.2.x | Ensure /etc/security/pwquality.conf.d exists"
  ansible.builtin.file:
    path: /etc/security/pwquality.conf.d
    state: directory
    owner: root
    group: root
    mode: '0755'

- name: "5.3.3.2.1 | PATCH | Ensure password number of changed characters is configured"
  block:
    - name: "5.3.3.2.1 | Remove difok from conf files except expected file"
      ansible.builtin.replace:
        path: "{{ item }}"
        regexp: 'difok\s*=\s*\d+\b'
        replace: ''
      with_fileglob:
        - '/etc/security/pwquality.conf'
        - '/etc/security/pwquality.conf.d/*.conf'
        - '/etc/pam.d/common-password'
      when:
        - item != 'etc/security/pwquality.conf.d/50-pwdifok.conf'

    - name: "5.3.3.2.1 | Ensure difok file exists"
      ansible.builtin.template:
        src: '{{ ansible_dir }}/ubu22/templates/etc/security/pwquality.conf.d/50-pwdifok.conf.j2'
        dest: '/etc/security/pwquality.conf.d/50-pwdifok.conf'
        owner: root
        group: root
        mode: 'go-rwx'
  when: rule_5_3_3_2_1

- name: "5.3.3.2.2 | PATCH | Ensure minimum password length is configured"
  block:
    - name: "5.3.3.2.2 | Remove minlen from conf files except expected file"
      ansible.builtin.replace:
        path: "{{ item }}"
        regexp: 'minlen\s*=\s*\d+\b'
        replace: ''
      with_fileglob:
        - '/etc/security/pwquality.conf'
        - '/etc/security/pwquality.conf.d/*.conf'
        - '/etc/pam.d/common-password'
      when:
        - item != 'etc/security/pwquality.conf.d/50-pwlength.conf'

    - name: "5.3.3.2.2 | Ensure minlen file exists"
      ansible.builtin.template:
        src: '{{ ansible_dir }}/ubu22/templates/etc/security/pwquality.conf.d/50-pwlength.conf.j2'
        dest: '/etc/security/pwquality.conf.d/50-pwlength.conf '
        owner: root
        group: root
        mode: 'go-rwx'
  when: rule_5_3_3_2_2

- name: "5.3.3.2.3 | PATCH | Ensure password complexity is configured"
  block:
    - name: "5.3.3.2.3 | Remove pwd complex settings from conf files except expected file"
      ansible.builtin.replace:
        path: "{{ item }}"
        regexp: '(minclass|[dulo]credit)\s*=\s*(-\d|\d+)\b'
        replace: ''
      with_fileglob:
        - '/etc/security/pwquality.conf'
        - '/etc/security/pwquality.conf.d/*.conf'
        - '/etc/pam.d/common-password'
      when:
        - item != 'etc/security/pwquality.conf.d/50-pwcomplexity.conf'

    - name: "5.3.3.2.3 | Ensure complexity file exists"
      ansible.builtin.template:
        src: '{{ ansible_dir }}/ubu22/templates/etc/security/pwquality.conf.d/50-pwcomplexity.conf.j2'
        dest: '/etc/security/pwquality.conf.d/50-pwcomplexity.conf'
        owner: root
        group: root
        mode: 'go-rwx'
  when: rule_5_3_3_2_3

- name: "5.3.3.2.4 | PATCH | Ensure password same consecutive characters is configured"
  block:
    - name: "5.3.3.2.4 | Remove maxrepeat settings from conf files except expected file"
      ansible.builtin.replace:
        path: "{{ item }}"
        regexp: 'maxrepeat\s*=\s*\d+\b'
        replace: ''
      with_fileglob:
        - '/etc/security/pwquality.conf'
        - '/etc/security/pwquality.conf.d/*.conf'
        - '/etc/pam.d/common-password'
      when:
        - item != 'etc/security/pwquality.conf.d/50-pwrepeat.conf'

    - name: "5.3.3.2.4 | Ensure maxrepeat file exists"
      ansible.builtin.template:
        src: '{{ ansible_dir }}/ubu22/templates/etc/security/pwquality.conf.d/50-pwrepeat.conf.j2'
        dest: '/etc/security/pwquality.conf.d/50-pwrepeat.conf'
        owner: root
        group: root
        mode: 'go-rwx'
  when: rule_5_3_3_2_4

- name: "5.3.3.2.5 | PATCH | Ensure password maximum sequential characters is configured"
  block:
    - name: "5.3.3.2.5 | Remove maxsequence settings from conf files except expected file"
      ansible.builtin.replace:
        path: "{{ item }}"
        regexp: 'maxsequence\s*=\s*\d+\b'
        replace: ''
      with_fileglob:
        - '/etc/security/pwquality.conf'
        - '/etc/security/pwquality.conf.d/*.conf'
        - '/etc/pam.d/common-password'
      when:
        - item != 'etc/security/pwquality.conf.d/50-pwmaxsequence.conf'

    - name: "5.3.3.2.5 | Ensure maxsequence file exists"
      ansible.builtin.template:
        src: '{{ ansible_dir }}/ubu22/templates/etc/security/pwquality.conf.d/50-pwmaxsequence.conf.j2'
        dest: '/etc/security/pwquality.conf.d/50-pwmaxsequence.conf'
        owner: root
        group: root
        mode: 'go-rwx'
  when: rule_5_3_3_2_5

- name: "5.3.3.2.6 | PATCH | Ensure password dictionary check is enabled"
  block:
    - name: "5.3.3.2.6 | Remove dictcheck settings from conf files except expected file"
      ansible.builtin.replace:
        path: "{{ item }}"
        regexp: 'dictcheck\s*=\s*\d+\b'
        replace: ''
      with_fileglob:
        - '/etc/security/pwquality.conf'
        - '/etc/security/pwquality.conf.d/*.conf'
        - '/etc/pam.d/common-password'
      when:
        - item != 'etc/security/pwquality.conf.d/50-pwdictcheck.conf'

    - name: "5.3.3.2.6 | Ensure dictcheck file exists"
      ansible.builtin.template:
        src: '{{ ansible_dir }}/ubu22/templates/etc/security/pwquality.conf.d/50-pwdictcheck.conf.j2'
        dest: '/etc/security/pwquality.conf.d/50-pwdictcheck.conf'
        owner: root
        group: root
        mode: 'go-rwx'
  when: rule_5_3_3_2_6

- name: "5.3.3.2.7 | PATCH | Ensure password quality checking is enforced"
  block:
    - name: "5.3.3.2.7 | Remove quality enforcement settings from conf files except expected file"
      ansible.builtin.replace:
        path: "{{ item }}"
        regexp: 'enforcing\s*=\s*\d+\b'
        replace: ''
      with_fileglob:
        - '/etc/security/pwquality.conf'
        - '/etc/security/pwquality.conf.d/*.conf'
        - '/etc/pam.d/common-password'
      when:
        - item != 'etc/security/pwquality.conf.d/50-pwquality_enforce.conf'

    - name: "5.3.3.2.7 | Ensure quality enforcement file exists"
      ansible.builtin.template:
        src: '{{ ansible_dir }}/ubu22/templates/etc/security/pwquality.conf.d/50-pwquality_enforce.conf.j2'
        dest: '/etc/security/pwquality.conf.d/50-pwquality_enforce.conf'
        owner: root
        group: root
        mode: 'go-rwx'
  when: rule_5_3_3_2_7

- name: "5.3.3.2.8 | PATCH | Ensure password quality is enforced for the root user"
  ansible.builtin.template:
    src: '{{ ansible_dir }}/ubu22/templates/etc/security/pwquality.conf.d/50-pwroot.conf.j2'
    dest: '/etc/security/pwquality.conf.d/50-pwroot.conf'
    owner: root
    group: root
    mode: 'go-rwx'
  when: rule_5_3_3_2_8

- name: "5.3.3.3.1 | PATCH | Ensure password history remember is configured"
  block:
    - name: "5.3.3.3.1 | Check existing files"
      ansible.builtin.shell: grep -Psi -- '^\h*password\h+[^#\n\r]+\h+pam_pwhistory\.so\h+([^#\n\r]+\h+)?remember=\d+\b' /etc/pam.d/common-password
      register: discovered_pwhistory_remember
      changed_when: false
      failed_when: discovered_pwhistory_remember.rc not in [0, 1]

    - name: "5.3.3.3.1 | Ensure remember is set"
      ansible.builtin.lineinfile:
        path: '/usr/share/pam-configs/pwhistory'
        regexp: ^(password\s+[^#\n\r]+\s+pam_pwhistory\.so\s+)(.*)(remember=\d+)
        line: '\1\2\3 remember=24'
        backrefs: true
      when: discovered_pwhistory_remember.stdout | length > 0
      notify: Pam_auth_update_pwhistory
      ignore_errors: yes
  when:
    - rule_5_3_3_3_1
    - disruption_high

- name: "5.3.3.3.2 | PATCH | Ensure password history is enforced for the root user"
  block:
    - name: "5.3.3.3.2 | Check existing files"
      ansible.builtin.shell: grep -Psi -- '^\h*password\h+[^#\n\r]+\h+pam_pwhistory\.so\h+([^#\n\r]+\h+)?enforce_for_root\b' /etc/pam.d/common-password
      register: discovered_pwhistory_remember
      changed_when: false
      failed_when: discovered_pwhistory_remember.rc not in [0, 1]

    - name: "5.3.3.3.2 | Ensure remember is set"
      ansible.builtin.lineinfile:
        path: '/usr/share/pam-configs/pwhistory'
        regexp: ^(password\s+[^#\n\r]+\s+pam_pwhistory\.so\s+)(.*)(enforce_for_root)
        line: '\1\2\3 enforce_for_root'
        backrefs: true
      when: discovered_pwhistory_remember.stdout | length > 0
  when:
    - rule_5_3_3_3_2
    - disruption_high

- name: "5.3.3.3.3 | PATCH | Ensure pam_pwhistory includes use_authtok"
  block:
    - name: "5.3.3.3.3 | Check existing files"
      ansible.builtin.shell: grep -Psi -- '^\h*password\h+[^#\n\r]+\h+pam_pwhistory\.so\h+([^#\n\r]+\h+)?use_authtok\b' /etc/pam.d/common-password
      register: discovered_pwhistory_use_authtok
      changed_when: false
      failed_when: discovered_pwhistory_use_authtok.rc not in [0, 1]

    - name: "5.3.3.3.3 | Ensure remember is set"
      ansible.builtin.lineinfile:
        path: '/usr/share/pam-configs/pwhistory'
        regexp: ^(password\s+[^#\n\r]+\s+pam_pwhistory\.so\s+)(.*)(use_authtok)
        line: '\1\2\3 use_authtok'
        backrefs: true
      when: discovered_pwhistory_use_authtok.stdout | length > 0
  when:
    - rule_5_3_3_3_3
    - disruption_high

- name: "5.3.3.4.1 | PATCH | Ensure pam_unix does not include nullok"
  block:
    - name: "5.3.3.4.1 | capture state"
      ansible.builtin.shell: grep -E "pam_unix.so.*nullok" /etc/pam.d/common-* /usr/share/pam-configs/* | cut -d ':' -f1 | uniq
      changed_when: false
      failed_when: discovered_pam_nullok.rc not in [ 0, 1 ]
      register: discovered_pam_nullok

    - name: "5.3.3.4.1 | Ensure nullok removed"
      ansible.builtin.replace:
        path: "{{ item }}"
        regexp: nullok
        replace: ''
      loop: "{{ discovered_pam_nullok.stdout_lines }}"
      when: discovered_pam_nullok.stdout | length > 0
  when:
    - rule_5_3_3_4_1
    - disruption_high

- name: "5.3.3.4.2 | PATCH | Ensure pam_unix does not include remember"
  block:
    - name: "5.3.3.4.2 | capture state"
      ansible.builtin.shell: grep -PH -- '^\h*^\h*[^#\n\r]+\h+pam_unix\.so\b' /etc/pam.d/common-{password,auth,account,session,session-noninteractive} | grep -Pv -- '\bremember=\d\b'
      changed_when: false
      failed_when: discovered_pam_remember.rc not in [ 0, 1 ]
      register: discovered_pam_remember

    - name: "5.3.3.4.2 | Ensure remember removed"
      ansible.builtin.replace:
        path: "/usr/share/pam-configs/pam_unix"
        regexp: remember=\d+
        replace: ''
      when: discovered_pam_remember.stdout | length > 0
  when: rule_5_3_3_4_2

- name: "5.3.3.4.3 | PATCH | Ensure pam_unix includes a strong password hashing algorithm"
  block:
    - name: "5.3.3.4.3 | capture state"
      ansible.builtin.shell: grep -PH -- '^\h*password\h+([^#\n\r]+)\h+pam_unix\.so\h+([^#\n\r]+\h+)?(yescrypt)\b' /etc/pam.d/common-password
      changed_when: false
      failed_when: discovered_pam_pwhash.rc not in [ 0, 1 ]
      register: discovered_pam_pwhash

    - name: "5.3.3.4.3 | Ensure hash algorithm set"
      ansible.builtin.replace:
        path: "/usr/share/pam-configs/pam_unix"
        regexp: "(md5|bigcrypt|sha256|blowfish|gost_yescrypt|sha512|yescrypt)"
        replace: 'yescrypt'
      when: discovered_pam_remember.stdout | length > 0
  when: rule_5_3_3_4_3

- name: "5.3.3.4.4 | PATCH | Ensure pam_unix includes use_authtok"
  block:
    - name: "5.3.3.4.4 | capture state"
      ansible.builtin.shell: grep -PH -- '^\h*password\h+([^#\n\r]+)\h+pam_unix\.so\h+([^#\n\r]+\h+)?use_authtok\b' /etc/pam.d/common-password
      changed_when: false
      failed_when: discovered_pam_authtok.rc not in [ 0, 1 ]
      register: discovered_pam_authtok

    - name: "5.3.3.4.4 | pam_files"
      ansible.builtin.lineinfile:
        path: "/etc/pam.d/common-password"
        regexp: ^(\s*password\s+[success=end.*]\s+pam_unix\.so)(.*)\s+use_authtok\s*=\s*\S+(.*$)
        line: \1\2\3 use_authtok
        backrefs: true
      when:
        - discovered_pam_authtok is defined
        - discovered_pam_authtok | length > 0
  when: rule_5_3_3_4_4
[[[TODO: consolidate PAM shit]]]

[[[TODO: consolidate login.defs]]]
---

- name: "5.4.1.1 | PATCH | Ensure password expiration is configured"
  block:
    - name: "5.4.1.1 | Set /etc/login.defs PASS_MAX_DAYS"
      ansible.builtin.lineinfile:
        path: /etc/login.defs
        regexp: '^PASS_MAX_DAYS|^#PASS_MAX_DAYS'
        line: 'PASS_MAX_DAYS 365'
        insertafter: '# Password aging controls'

    - name: "5.4.1.1 | Get existing users PASS_MAX_DAYS"
      ansible.builtin.shell: "awk -F: '(/^[^:]+:[^!*]/ && ($5>365 || $5<1 || $5 == -1)){print $1}' /etc/shadow"
      changed_when: false
      failed_when: false
      register: discovered_max_days

    - name: "5.4.1.1 | Set existing users PASS_MAX_DAYS"
      ansible.builtin.command: chage --maxdays 365 {{ item }}
      failed_when: false
      changed_when: discovered_max_days.stdout | length > 0
      loop: "{{ discovered_max_days.stdout_lines }}"
      when:
        - disruption_high
        - (item != 'root')
  when: rule_5_4_1_1

- name: "5.4.1.2 | PATCH | Ensure minimum password age is configured"
  block:
    - name: "5.4.1.2 | Set /etc/login.defs PASS_MIN_DAYS"
      ansible.builtin.lineinfile:
        path: /etc/login.defs
        regexp: '^PASS_MIN_DAYS|^#PASS_MIN_DAYS'
        line: 'PASS_MIN_DAYS 1'

    - name: "5.4.1.2 | Get existing users PASS_MIN_DAYS"
      ansible.builtin.command: "awk -F: '(/^[^:]+:[^!*]/ && ($4<1)) {print $1}' /etc/shadow"
      changed_when: false
      failed_when: false
      register: discovered_passwd_min_days

    - name: "5.4.1.2 | Set existing users PASS_MIN_DAYS"
      ansible.builtin.command: chage --mindays 1 {{ item }}
      failed_when: false
      changed_when: discovered_passwd_min_days.stdout |length > 0
      loop: "{{ discovered_passwd_min_days.stdout_lines }}"
      when:
        - disruption_high
        - (item != 'root')
  when: rule_5_4_1_2

- name: "5.4.1.3 | PATCH | Ensure password expiration warning days is configured"
  block:
    - name: "5.4.1.3 | Set /etc/login.defs PASS_WARN_AGE"
      ansible.builtin.lineinfile:
        path: /etc/login.defs
        regexp: '^PASS_WARN_AGE|^#PASS_WARN_AGE'
        line: 'PASS_WARN_AGE 7'

    - name: "5.4.1.3 | Get existing users PASS_WARN_AGE"
      ansible.builtin.shell: "awk -F: '(/^[^:]+:[^!*]/ && $6<7){print $1}' /etc/shadow"
      changed_when: false
      failed_when: false
      register: discovered_passwd_warn_days

    - name: "5.4.1.3 | Set existing users PASS_WARN_AGE"
      ansible.builtin.command: chage --maxdays 7 {{ item }}
      failed_when: false
      changed_when: discovered_passwd_warn_days.stdout | length > 0
      loop: "{{ discovered_passwd_warn_days.stdout_lines }}"
      when:
        - disruption_high
        - (item != 'root')
  when: rule_5_4_1_3

- name: "5.4.1.4 | PATCH | Ensure strong password hashing algorithm is configured"
  ansible.builtin.lineinfile:
    path: /etc/login.defs
    regexp: '^ENCRYPT_METHOD'
    line: 'ENCRYPT_METHOD YESCRYPT'
  when: rule_5_4_1_4

- name: "5.4.1.5 | PATCH | Ensure inactive password lock is configured"
  block:
    - name: "5.4.1.5 | General setting"
      ansible.builtin.shell: useradd -D | grep INACTIVE | cut -d= -f2
      changed_when: false
      failed_when: false
      register: discovered_passwd_inactive_setting

    - name: "5.4.1.5 | Set inactive period for new users"
      ansible.builtin.command: useradd -D -f 45
      failed_when: false
      changed_when: true
      when: discovered_passwd_inactive_setting.stdout != 45 | string

    - name: "5.4.1.5 | Get Individual users"
      ansible.builtin.shell: awk -F':' '(/^[^:]+:[^!*]/ && ($7~/(\\s*|-1)/ || ( $7>1 && $7<45))) {print $1}' /etc/shadow
      changed_when: false
      failed_when: false
      register: discovered_passwd_inactive_users

    - name: "5.4.1.5 | Set inactive period for existing users"
      ansible.builtin.command: chage --inactive 45 {{ item }}
      failed_when: false
      changed_when: true
      with_items:
        - "{{ ubu22_passwd | map(attribute='id') | list | intersect(discovered_passwd_inactive_users.stdout_lines) | list }}"
      when:
        - disruption_high
        - discovered_passwd_inactive_users.stdout | length > 0
        - (item != 'root')
  when: rule_5_4_1_5

- name: "5.4.1.6 | PATCH | Ensure all users last password change date is in the past"
  block:
    - name: "5.4.1.6 | Get current date in Unix Time"
      ansible.builtin.shell: echo $(($(date --utc --date "$1" +%s)/86400))
      changed_when: false
      failed_when: false
      check_mode: false
      register: discovered_current_time

    - name: "5.4.1.6 | Get list of users with last changed PW date in future"
      ansible.builtin.shell: "cat /etc/shadow | awk -F: '{if($3>{{ discovered_current_time.stdout }})print$1}'"
      changed_when: false
      failed_when: false
      check_mode: false
      register: discovered_passwd_future_user_list

    - name: "5.4.1.6 | Warn about users"
      ansible.builtin.debug:
        msg:
          - "WARNING!! The following accounts have the last PW change date in the future"
          - "{{ discovered_passwd_future_user_list.stdout_lines }}"
      when: discovered_passwd_future_user_list.stdout | length > 0

    - name: "5.4.1.6 | Lock accounts with future PW changed dates"
      ansible.builtin.command: passwd --expire {{ item }}
      failed_when: false
      changed_when: true
      with_items:
        - "{{ discovered_passwd_future_user_list.stdout_lines }}"
      when:
        - disruption_high
        - discovered_passwd_future_user_list.stdout | length > 0
  when: rule_5_4_1_6

- name: "5.4.2.1 | PATCH | Ensure root is the only UID 0 account"
  ansible.builtin.command: passwd -l {{ item }}
  changed_when: false
  failed_when: false
  loop: "{{ prelim_uid_zero_accounts_except_root.stdout_lines }}"
  when:
    - rule_5_4_2_1
    - prelim_uid_zero_accounts_except_root.rc
    - disruption_high

- name: "5.4.2.2 | PATCH | Ensure root is the only GID 0 account"
  block:
    - name: "5.4.2.2 | Get members of gid 0"
      ansible.builtin.shell: "awk -F: '($1 !~ /^(sync|shutdown|halt|operator)/ && $4==\"0\") {print $1}' /etc/passwd | grep -wv 'root'"
      changed_when: false
      failed_when: discovered_gid0_members.rc not in [ 0, 1 ]
      register: discovered_gid0_members

    - name: "5.4.2.2 | Remove users not root from gid 0"
      ansible.builtin.user:
        name: "{{ item }}"
        group: root
        state: absent
      loop: "{{ discovered_gid0_members.stdout_lines }}"
      when:
        - discovered_gid0_members is defined
        - discovered_gid0_members.stdout | length > 0
  when:
    - rule_5_4_2_2
    - disruption_high

- name: "5.4.2.3 | AUDIT | Ensure group root is the only GID 0 group"
  block:
    - name: "5.4.2.3 | Get groups with gid 0"
      ansible.builtin.shell: "awk -F: '$3==\"0\"{print $1}' /etc/group | grep -vw 'root'"
      changed_when: false
      failed_when: discovered_gid0_groups.rc not in [ 0, 1 ]
      register: discovered_gid0_groups

    - name: "5.4.2.3 | Warning if others gid 0 groups"
      ansible.builtin.debug:
        msg:
          - "Warning!! You have other groups assigned to GID 0 - Please resolve"
          - "{{ discovered_gid0_groups.stdout_lines }}"
      when:
        - discovered_gid0_groups is defined
        - discovered_gid0_groups.stdout | length > 0
  when: rule_5_4_2_3

- name: "5.4.2.4 | PATCH | Ensure root password is set"
  block:
    - name: "5.4.2.4"
      ansible.builtin.shell: passwd -S root | grep -E "root P"
      changed_when: false
      failed_when: false
      register: root_passwd_set

    - name: "5.4.2.4"
      ansible.builtin.assert:
        that: root_passwd_set.rc == 0
        fail_msg: "You have rule 5.4.2.4 enabled this requires that you have a root password set - Please manually set a root password"
        success_msg: "You have a root password set"
  when: rule_5_4_2_4
  ignore_errors: yes

- name: "5.4.2.5 | PATCH | Ensure root PATH Integrity"
  block:
    - name: "5.4.2.5 | Get root paths"
      ansible.builtin.shell: sudo -Hiu root env | grep '^PATH' | cut -d= -f2
      changed_when: false
      register: discovered_root_paths

    - name: "5.4.2.5 | Get root paths"
      ansible.builtin.shell: sudo -Hiu root env | grep '^PATH' | cut -d= -f2 | tr ":" "\n"
      changed_when: false
      register: discovered_root_paths_split
      when: discovered_root_paths is defined

    - name: "5.4.2.5 | Set fact"
      ansible.builtin.set_fact:
        root_paths: "{{ discovered_root_paths.stdout }}"
      when: discovered_root_paths is defined

    - name: "5.4.2.5 | Check for empty dirs"
      ansible.builtin.shell: 'echo {{ root_paths }} | grep -q "::" && echo "roots path contains a empty directory (::)"'
      changed_when: false
      failed_when: discovered_root_path_empty_dir.rc not in [ 0, 1 ]
      register: discovered_root_path_empty_dir
      when: discovered_root_paths is defined

    - name: "5.4.2.5 | Check for trailing ':'"
      ansible.builtin.shell: "echo {{ root_paths }} | grep -q \":$\" && echo \"roots path contains a trailing (:)\""
      changed_when: false
      failed_when: discovered_root_path_trailing_colon.rc not in [ 0, 1 ]
      register: discovered_root_path_trailing_colon
      when: discovered_root_paths is defined

    - name: "5.4.2.5 | AUDIT | Ensure root PATH Integrity | Check for owner and permissions"
      block:
        - name: "5.4.2.5 | Check for owner and permissions"
          ansible.builtin.stat:
            path: "{{ item }}"
          register: discovered_root_path_perms
          loop: "{{ discovered_root_paths_split.stdout_lines }}"

        - name: "5.4.2.5 | Set permissions"
          ansible.builtin.file:
            path: "{{ item.stat.path }}"
            state: directory
            owner: root
            group: root
            mode: 'go-w'
            follow: false
          loop: "{{ discovered_root_path_perms.results }}"
          loop_control:
            label: "{{ item }}"
          when:
            - item.stat.exists
            - item.stat.isdir
            - item.stat.pw_name != 'root' or item.stat.gr_name != 'root' or item.stat.woth or item.stat.wgrp
            - (item != 'root')
      when: discovered_root_paths is defined
  when: rule_5_4_2_5
  ignore_errors: yes

- name: "5.4.2.6 | PATCH | Ensure root user umask is configured"
  ansible.builtin.lineinfile:
    path: /root/.bash_profile
    regexp: \s*umask
    line: "umask 0027"
    create: true
    owner: root
    group: root
    mode: 'g-wx,o-rwx'
  when: rule_5_4_2_6

- name: "5.4.2.7 | PATCH | Ensure system accounts do not have a valid login shell"
  ansible.builtin.user:
    name: "{{ item.id }}"
    shell: /usr/sbin/nologin
  loop: "{{ ubu22_passwd }}"
  loop_control:
    label: "{{ item.id }}"
  when:
    - rule_5_4_2_7
    - "item.id not in prelim_interactive_usernames.stdout"
    - "'root' not in item.id"
    - disruption_high

- name: "5.4.2.8 | PATCH | Ensure accounts without a valid login shell are locked | Lock accounts"
  ansible.builtin.user:
    name: "{{ item.id }}"
    password_lock: true
  loop: "{{ ubu22_passwd }}"
  loop_control:
    label: "{{ item.id }}"
  when:
    - rule_5_4_2_8
    - disruption_high
    - "item.id not in prelim_interactive_usernames.stdout"
    - "'root' not in item.id"

- name: "5.4.3.1 | PATCH | Ensure nologin is not listed in /etc/shells"
  ansible.builtin.replace:
    path: /etc/shells
    regexp: nologin
    replace: ""
  when: rule_5_4_3_1

- name: "5.4.3.2 | PATCH | Ensure default user shell timeout is configured"
  ansible.builtin.blockinfile:
    path: "{{ item.path }}"
    state: "{{ item.state }}"
    marker: "# {mark} - CIS benchmark - Ansible-lockdown"
    create: true
    mode: 'u-x,go-wx'
    block: |
      TMOUT=900
      readonly TMOUT
      export TMOUT
  loop:
    - { path: /etc/profile.d/tmout.sh, state: present }
    - { path: /etc/profile, state: "{{ ('/etc/profile.d/tmout.sh' == '/etc/profile') | ternary('present', 'absent') }}" }
  when: rule_5_4_3_2

- name: "5.4.3.3 | PATCH | Ensure default user umask is configured"
  ansible.builtin.replace:
    path: "{{ item.path }}"
    regexp: (?i)(umask\s+\d\d\d)
    replace: '{{ item.line }} 027'
  loop:
    - { path: '/etc/profile', line: 'umask' }
    - { path: '/etc/login.defs', line: 'UMASK' }
  when: rule_5_4_3_3
[[[TODO: consolidate login.defs]]]

[[[TODO: consolidate]]]
- name: "6.2.1.1.x | Ensure that /etc/systemd/journald.conf.d exists"
  ansible.builtin.file:
    path: /etc/systemd/journald.conf.d
    state: directory
    owner: root
    group: root
    mode: '0755'

- name: "6.2.1.1.1 | PATCH | Ensure journald service is enabled and active"
  ansible.builtin.systemd:
    name: systemd-journald.service
    masked: false
    state: started
  when: rule_6_2_1_1_1

- name: "6.2.1.1.2 | PATCH | Ensure journald log file access is configured"
  block:
    - name: "6.2.1.1.2 | Default file permissions"
      ansible.builtin.file:
        path: /usr/lib/tmpfiles.d/systemd.conf
        mode: 'g-wx,o-rwx'

    - name: "6.2.1.1.2 | Check for override file"
      ansible.builtin.stat:
        path: /etc/tmpfiles.d/systemd.conf
      register: discovered_tmpfile_override

    - name: "6.2.1.1.2 | If override file check for journal"
      ansible.builtin.shell: grep -E 'z /var/log/journal/%m/system.journal \d*' /usr/lib/tmpfiles.d/systemd.conf
      changed_when: false
      failed_when: discovered_journald_fileperms_override.rc not in [ 0, 1 ]
      register: discovered_journald_fileperms_override
      when: discovered_tmpfile_override.stat.exists

    - name: "6.2.1.1.2 | Warning if override found"
      ansible.builtin.debug:
        msg: "Warning!! - tmpfiles override found /usr/lib/tmpfiles.d/systemd.conf affecting journald files please confirm matches site policy"
      when:
        - discovered_tmpfile_override.stat.exists
        - discovered_journald_fileperms_override.stdout | length > 0
  when: rule_6_2_1_1_2

- name: "6.2.1.1.3 | PATCH | Ensure journald log file rotation is configured"
  block:
    - name: "6.2.1.1.3 | Add file"
      ansible.builtin.template:
        src: '{{ ansible_dir }}/ubu22/templates/etc/systemd/journald.conf.d/rotation.conf.j2'
        dest: '/etc/systemd/journald.conf.d/rotation.conf'
        owner: root
        group: root
        mode: 'g-wx,o-rwx'

    - name: "6.2.1.1.3 | comment out current entries"
      ansible.builtin.replace:
        path: /etc/systemd/journald.conf
        regexp: "{{ item }}"
        replace: '#\1'
      loop:
        - '^(\s*SystemMaxUse\s*=.*)'
        - '^(\s*SystemKeepFree\s*=.*)'
        - '^(\s*RuntimeMaxUse\s*=)'
        - '^(\s*RuntimeKeepFree\s*=.*)'
        - '^(\s*MaxFileSec\s*=.*)'
  when: rule_6_2_1_1_3

- name: "6.2.1.1.4 | PATCH | Ensure journald ForwardToSyslog is disabled"
  block:
    - name: "6.2.1.1.4 | Add file"
      ansible.builtin.template:
        src: '{{ ansible_dir }}/ubu22/templates/etc/systemd/journald.conf.d/forwardtosyslog.conf.j2'
        dest: '/etc/systemd/journald.conf.d/forwardtosyslog.conf'
        owner: root
        group: root
        mode: 'g-wx,o-rwx'

    - name: "6.2.1.1.4 | comment out current entries"
      ansible.builtin.replace:
        path: /etc/systemd/journald.conf
        regexp: ^(\s*ForwardToSyslog)
        replace: '#\1'
  when: rule_6_2_1_1_4

- name: "6.2.1.1.5 | PATCH | Ensure journald Storage is configured"
  block:
    - name: "6.2.1.1.5 | Add file"
      ansible.builtin.template:
        src: '{{ ansible_dir }}/ubu22/templates/etc/systemd/journald.conf.d/storage.conf.j2'
        dest: '/etc/systemd/journald.conf.d/storage.conf'
        owner: root
        group: root
        mode: 'g-wx,o-rwx'

    - name: "6.2.1.1.5 | comment out current entries"
      ansible.builtin.replace:
        path: /etc/systemd/journald.conf
        regexp: ^(?i)(\s*storage=)
        replace: '#\1'
  when: rule_6_2_1_1_5

- name: "6.2.1.1.6 | PATCH | Ensure journald Compress is configured"
  block:
    - name: "6.2.1.1.6 | Add file"
      ansible.builtin.template:
        src: '{{ ansible_dir }}/ubu22/templates/etc/systemd/journald.conf.d/storage.conf.j2'  # Added to the same file as 6.2.1.1.5
        dest: '/etc/systemd/journald.conf.d/storage.conf'
        owner: root
        group: root
        mode: 'g-wx,o-rwx'

    - name: "6.2.1.1.6 | comment out current entries"
      ansible.builtin.replace:
        path: /etc/systemd/journald.conf
        regexp: ^(?i)(\s*compress=)
        replace: '#\1'
  when: rule_6_2_1_1_6

- name: "6.2.2.1 | PATCH | Ensure access to all logfiles has been configured"
  block:
    - name: "6.2.2.1 | find files"
      ansible.builtin.shell: find /var/log/ -type f -exec ls {} \;
      changed_when: false
      failed_when: false
      register: discovered_system_logfiles

    - name: "6.2.2.1 | change permissions"
      ansible.builtin.file:
        path: "{{ item }}"
        mode: 'u-x,g-wx,o-rwx'
      loop: "{{ discovered_system_logfiles.stdout_lines }}"
      when:
        - discovered_system_logfiles.stdout_lines is defined
        - item != "/var/log/btmp"
        - item != "/var/log/utmp"
        - item != "/var/log/wtmp"
        - item != "/var/log/lastlog"

    - name: "6.2.2.1 | change permissions"
      ansible.builtin.file:
        path: "{{ item }}"
        mode: 'ug-x,o-wx'
      with_fileglob:
        - "/var/log/*tmp"
        - "/var/log/lastlog*"
        - "/var/log/sssd*"
        - "/var/log/SSSD*"
  when: rule_6_2_2_1
  ignore_errors: yes
[[[[TODO: consolidate]]]]


[[[TODO: consolidate file perms]]]
- name: "7.1.1 | PATCH | Ensure permissions on /etc/passwd are configured"
  ansible.builtin.file:
    path: /etc/passwd
    owner: root
    group: root
    mode: 'u-x,go-wx'
  when: rule_7_1_1

- name: "7.1.2 | PATCH | Ensure permissions on /etc/passwd- are configured"
  ansible.builtin.file:
    path: /etc/passwd-
    owner: root
    group: root
    mode: 'u-x,go-wx'
  failed_when: discovered_password_hyphen_file_exists.state not in '[ file, absent ]'
  register: discovered_password_hyphen_file_exists
  when: rule_7_1_2

- name: "7.1.3 | PATCH | Ensure permissions on /etc/group are configured"
  ansible.builtin.file:
    path: /etc/group
    owner: root
    group: root
    mode: 'u-x,go-wx'
  when: rule_7_1_3

- name: "7.1.4 | PATCH | Ensure permissions on /etc/group- are configured"
  ansible.builtin.file:
    path: /etc/group-
    owner: root
    group: root
    mode: 'u-x,go-wx'
  failed_when: discovered_group_hyphen_file_exists.state not in '[ file, absent ]'
  register: discovered_group_hyphen_file_exists
  when: rule_7_1_4

- name: "7.1.5 | PATCH | Ensure permissions on /etc/shadow are configured"
  ansible.builtin.file:
    path: /etc/shadow
    owner: root
    group: root
    mode: 'u-x,g-wx,o-rwx'
  when: rule_7_1_5

- name: "7.1.6 | PATCH | Ensure permissions on /etc/shadow- are configured"
  ansible.builtin.file:
    path: /etc/shadow-
    owner: root
    group: root
    mode: 'u-x,g-wx,o-rwx'
  failed_when: discovered_shadows_hyphen_file_exists.state not in '[ file, absent ]'
  register: discovered_shadows_hyphen_file_exists
  when: rule_7_1_6

- name: "7.1.7 | PATCH | Ensure permissions on /etc/gshadow are configured"
  ansible.builtin.file:
    path: /etc/gshadow
    owner: root
    group: root
    mode: 'u-x,g-wx,o-rwx'
  when: rule_7_1_7

- name: "7.1.8 | PATCH | Ensure permissions on /etc/gshadow- are configured"
  ansible.builtin.file:
    path: /etc/gshadow-
    owner: root
    group: root
    mode: 'u-x,g-wx,o-rwx'
  failed_when: discovered_gshadow_hyphen_file_exists.state not in '[ file, absent ]'
  register: discovered_gshadow_hyphen_file_exists
  when: rule_7_1_8

- name: "7.1.9 | PATCH | Ensure permissions on /etc/shells are configured"
  ansible.builtin.file:
    path: /etc/shells
    owner: root
    group: root
    mode: 'u-x,go-wx'
  when: rule_7_1_9

- name: "7.1.10 | PATCH | Ensure permissions on /etc/security/opasswd are configured"
  ansible.builtin.file:
    path: "{{ item }}"
    owner: root
    group: root
    mode: 'u-x,go-rwx'
  failed_when: discovered_opasswd_file_exists.state not in '[ file, absent ]'
  register: discovered_opasswd_file_exists
  loop:
    - /etc/security/opasswd
    - /etc/security/opasswd.old
  when: rule_7_1_10

- name: "7.1.11 | PATCH | Ensure world writable files and directories are secured"
  block:
    - name: "7.1.11 | Get list of world-writable files"
      ansible.builtin.shell: df --local -P | awk {'if (NR!=1) print $6'} | xargs -I '{}' find '{}' -xdev -type f -perm -0002
      failed_when: false
      changed_when: false
      register: discovered_worldwriteable_files

      #set to false for now justin says no
    - name: "7.1.11 | Adjust world-writable files if they exist (Configurable)"
      ansible.builtin.file:
        path: '{{ item }}'
        mode: 'o-w'
        state: touch
      loop: "{{ discovered_worldwriteable_files.stdout_lines }}"
      when:
        - false
        - discovered_worldwriteable_files.stdout_lines is defined

    - name: "7.1.11 | sticky bit set on world-writable directories"
      ansible.builtin.shell: df --local -P | awk {'if (NR!=1) print $6'} | xargs -I '{}' find '{}' -xdev -type d -perm -0002 2>/dev/null | xargs chmod a+t
      changed_when: false
      failed_when: false
  when: rule_7_1_11

- name: "7.1.12 | PATCH | Ensure no files or directories without an owner and a group exist"
  block:
    - name: "7.1.12 | Get list files or directories"
      ansible.builtin.command: 'find (! -path "/run/user/*" -a ! -path "/proc/*" -a ! -path "*/containerd/*" -a ! -path "*/kubelet/pods/*" -a ! -path "*/kubelet/plugins/*" -a ! -path "/sys/fs/cgroup/memory/*" -a ! -path "/var/*/private/*") {{ item.mount }} -xdev \( -nouser -o -nogroup \) -not -fstype nfs'
      changed_when: false
      failed_when: false
      check_mode: false
      register: discovered_unowned_files
      loop: "{{ ansible_facts.mounts }}"
      loop_control:
        label: "{{ item.mount }}"

    - name: "7.1.12 | Flatten no_user_items results for easier use"
      ansible.builtin.set_fact:
        discovered_unowned_files_flatten: "{{ discovered_unowned_files.results | map(attribute='stdout_lines') | flatten }}"

    - name: "7.1.12 | Alert on unowned files and directories"
      ansible.builtin.debug:
        msg:
          - "Warning!! You have unowned files and are configured to not auto-remediate for this task"
          - "Please review the files/directories below and assign an owner"
          - "{{ discovered_unowned_files_flatten }}"
      when:
        - discovered_unowned_files_flatten | length > 0

      #we will review these manually for now
    - name: "7.1.12 | PATCH | Set files/directories to configured owner and group"
      ansible.builtin.file:
        path: "{{ item }}"
        owner: 'root'
        group: 'root'
      with_items:
        - "{{ discovered_unowned_files_flatten }}"
      when:
        - flase
        - discovered_unowned_files_flatten | length > 0
  when: rule_7_1_12

- name: "7.1.13 | AUDIT | Ensure SUID and SGID files are reviewed"
  block:
    - name: "7.1.13 | Find SUID and SGID"
      ansible.builtin.command: find {{ item.mount }} -xdev -type f -perm \( -02000 or -04000 \) -not -fstype nfs
      changed_when: false
      failed_when: false
      check_mode: false
      register: discovered_suid_sgid_files
      loop: "{{ ansible_facts.mounts }}"
      loop_control:
        label: "{{ item.mount }}"

    - name: "7.1.13 | Flatten suid_executables results for easier use"
      ansible.builtin.set_fact:
        discovered_suid_sgid_files_flatten: "{{ discovered_suid_sgid_files.results | map(attribute='stdout_lines') | flatten }}"

    - name: "7.1.13 | Alert SUID executables exist"
      ansible.builtin.debug:
        msg:
          - "Warning!! You have SUID executables"
          - "The files are listed below, please confirm the integrity of these binaries"
          - "{{ discovered_suid_sgid_files_flatten }}"
      when:
        - discovered_suid_sgid_files_flatten | length > 0

      #we will review these manually
    - name: "7.1.13 | PATCH | Audit SUID executables | Remove SUID bit"
      ansible.builtin.file:
        path: "{{ item }}"
        mode: 'u-s'
      loop: "{{ discovered_suid_sgid_files_flatten }}"
      when:
        - false
        - discovered_suid_sgid_files_flatten | length > 0
  when: rule_7_1_13
[[[TODO: consolidate file perms]]]

[[[TODO: consolidate]]]
- name: "7.2.1 | AUDIT | Ensure accounts in /etc/passwd use shadowed passwords"
  block:
    - name: "7.2.1 | Get users not using shadowed passwords"
      ansible.builtin.shell: awk -F':' '($2 != "x" ) { print $1}' /etc/passwd
      changed_when: false
      failed_when: false
      register: discovered_nonshadowed_users

    - name: "7.2.1 | Warn on findings"
      ansible.builtin.debug:
        msg:
          - "Warning!! You have users that are not using a shadowed password. Please convert the below accounts to use a shadowed password"
          - "{{ discovered_nonshadowed_users.stdout_lines }}"
      when: discovered_nonshadowed_users.stdout | length > 0
  when: rule_7_2_1

- name: "7.2.2 | PATCH | Ensure /etc/shadow password fields are not empty"
  block:
    - name: "7.2.2 | Find users with no password"
      ansible.builtin.shell: awk -F":" '($2 == "" ) { print $1 }' /etc/shadow
      changed_when: false
      check_mode: false
      register: discovered_empty_password_acct

    - name: "7.2.2 | Lock users with empty password"
      ansible.builtin.user:
        name: "{{ item }}"
        password_lock: true
      loop:
        - "{{ discovered_empty_password_acct.stdout_lines }}"
      when: discovered_empty_password_acct.stdout | length > 0
  when: rule_7_2_2

- name: "7.2.3 | AUDIT | Ensure all groups in /etc/passwd exist in /etc/group"
  block:
    - name: "7.2.3 | Check /etc/passwd entries"
      ansible.builtin.shell: pwck -r | grep 'no group' | awk '{ gsub("[:\47]",""); print $2}'
      changed_when: false
      failed_when: false
      check_mode: false
      register: discovered_passwd_gid_check

    - name: "7.2.3 | Print warning about users with invalid GIDs missing GID entries in /etc/group"
      ansible.builtin.debug:
        msg: "Warning!! The following users have non-existent GIDs (Groups): {{ discovered_passwd_gid_check.stdout_lines | join(', ') }}"
      when: discovered_passwd_gid_check.stdout | length > 0
  when: rule_7_2_3

- name: "7.2.4 | PATCH | Ensure shadow group is empty"
  block:
    - name: "7.2.4 | check users in group"
      ansible.builtin.getent:
        database: group
        split: ":"
        key: shadow

    - name: "7.2.4 | check users in group"
      ansible.builtin.debug:
        msg: "Warning!! - You have users in the shadow group"
      when: ansible_facts.getent_group.shadow[2] | length > 0
  when: rule_7_2_4

- name: "7.2.5 | AUDIT | Ensure no duplicate UIDs exist"
  block:
    - name: "7.2.5 | Check for duplicate UIDs"
      ansible.builtin.shell: "pwck -r | awk -F: '{if ($3 in uid) print $1 ; else uid[$3]}' /etc/passwd"
      changed_when: false
      failed_when: false
      check_mode: false
      register: discovered_user_uid_check

    - name: "7.2.5 | Print warning about users with duplicate UIDs"
      ansible.builtin.debug:
        msg: "Warning!! The following users have UIDs that are duplicates: {{ discovered_user_uid_check.stdout_lines }}"
      when: discovered_user_uid_check.stdout | length > 0
  when: rule_7_2_5

- name: "7.2.6 | AUDIT | Ensure no duplicate GIDs exist"
  block:
    - name: "7.2.6 | Check for duplicate GIDs"
      ansible.builtin.shell: "pwck -r | awk -F: '{if ($3 in users) print $1 ; else users[$3]}' /etc/group"
      changed_when: false
      failed_when: false
      check_mode: false
      register: discovered_user_gid_check

    - name: "7.2.6 | Print warning about users with duplicate GIDs"
      ansible.builtin.debug:
        msg: "Warning!! The following groups have duplicate GIDs: {{ discovered_user_gid_check.stdout_lines }}"
      when: discovered_user_gid_check.stdout | length > 0
  when: rule_7_2_6

- name: "7.2.7 | AUDIT | Ensure no duplicate user names exist"
  block:
    - name: "7.2.7 | Check for duplicate User Names"
      ansible.builtin.shell: "pwck -r | awk -F: '{if ($1 in users) print $1 ; else users[$1]}' /etc/passwd"
      changed_when: false
      failed_when: false
      check_mode: false
      register: discovered_dup_username

    - name: "7.2.7 | WARNING | Ensure no duplicate user names exist | Print warning about users with duplicate User Names"
      ansible.builtin.debug:
        msg: "Warning!! The following user names are duplicates: {{ discovered_dup_username.stdout_lines }}"
      when: discovered_dup_username.stdout | length > 0
  when: rule_7_2_7

- name: "7.2.8 | AUDIT | Ensure no duplicate group names exist"
  block:
    - name: "7.2.8 | Check for duplicate group names"
      ansible.builtin.shell: "getent passwd | cut -d: -f1 | sort -n | uniq -d"
      changed_when: false
      failed_when: false
      check_mode: false
      register: discovered_dup_group

    - name: "7.2.8 | Print warning about users with duplicate group names"
      ansible.builtin.debug:
        msg: "Warning!! The following group names are duplicates: {{ discovered_dup_group.stdout_lines }}"
      when: discovered_dup_group.stdout | length > 0
  when: rule_7_2_8

- name: "7.2.9 | PATCH | Ensure local interactive user home directories are configured"
  block:
    - name: "7.2.9 | Create dir if absent"
      ansible.builtin.file:  # noqa risky-file-permissions
        path: "{{ item.dir }}"
        state: directory
        owner: "{{ item.id }}"
        group: "{{ item.gid }}"
      loop: "{{ ubu22_passwd | selectattr('uid', '>=', min_int_uid | int) | selectattr('uid', '<=', max_int_uid | int) | list }}"
      loop_control:
        label: "{{ item.id }}"

    # set default ACLs so the homedir has an effective umask of 0027
    - name: "7.2.9 | Set group ACL"
      ansible.posix.acl:
        path: "{{ item }}"
        default: true
        etype: group
        permissions: rx
        state: present
      loop: "{{ prelim_interactive_users_home.stdout_lines }}"
      when: not system_is_container

    - name: "7.2.9 | Set other ACL"
      ansible.posix.acl:
        path: "{{ item }}"
        default: true
        etype: other
        permissions: 0
        state: present
      loop: "{{ prelim_interactive_users_home.stdout_lines }}"
      when: not system_is_container
  when: rule_7_2_9
  ignore_errors: yes

- name: "7.2.10 | PATCH | Ensure local interactive user dot files access is configured"
  block:
    - name: "7.2.10 | Check for files"
      ansible.builtin.shell: find /home/ -name "\.*" -perm /g+w,o+w
      changed_when: false
      failed_when: discovered_homedir_dot_files.rc not in [ 0, 1 ]
      check_mode: false
      register: discovered_homedir_dot_files

    - name: "7.2.10 | Warning on files found"
      ansible.builtin.debug:
        msg:
          - "Warning!! We have discovered group or world-writable dot files on your system and this host is configured for manual intervention. Please investigate
            these files further."
      when:
        - discovered_homedir_dot_files.stdout | length > 0

    - name: "7.2.10 | Changes files if configured"
      ansible.builtin.file:
        path: "{{ item }}"
        mode: 'go-w'
      with_items: "{{ discovered_homedir_dot_files.stdout_lines }}"
      when:
        - discovered_homedir_dot_files.stdout | length > 0
        - false
  when:
    - rule_7_2_10
    - disruption_high
[[[[TODO: consolidate]]]]

[[[TODO: consolidate]]]
- name: Copy SSHD Config
  copy:
    src: "{{ ansible_dir }}/ubu22/files/sshd_config"
    dest: /etc/ssh/sshd_config
    backup: yes

- name: OpenSSHd - Start and enable sshd
  ansible.builtin.systemd:
    name: sshd
    enabled: yes
    state: restarted
    masked: no

[[[TODO: refactor clamav?]]]
- name: ClamAV - Install clamav packages
  ansible.builtin.package:
    name: '{{ packages }}'
    state: present
  vars:
    packages:
    - clamav
    - clamav-base
    - clamav-daemon
    - clamav-freshclam
  register: clamav_install
  ignore_errors: true

- name: ClamAV - Run freshclam after ClamAV packages change.
  ansible.builtin.command: freshclam
  when: clamav_install.changed
  register: freshclam_result
  ignore_errors: yes
  failed_when:
    - freshclam_result is failed
    - freshclam_result.stderr.find('locked by another process') != -1

- name: ClamAV - Start and enable clamav-daemon
  ansible.builtin.systemd:
    name: clamav-daemon
    enabled: yes
    state: started
    masked: no
  ignore_errors: true

- name: ClamAV - Start and enable clamav-freshclam
  ansible.builtin.systemd:
    name: clamav-freshclam
    enabled: yes
    state: started
    masked: no
  ignore_errors: true

