---
- name: "HARDEN_OS UBUNTU | Secure IPv4 and IPv6 and restrict core dumps"
  block:
      # TODO: Create exclusion for kube
    - name: "Replace sysctl.conf with ours"
      ansible.builtin.copy:
        src: ubu/sysctl.conf
        dest: /etc/sysctl.conf
        owner: root
        group: root
        mode: 0744
        backup: yes

    - name: "Replace coredump.conf with ours"
      ansible.builtin.copy:
        src: ubu/coredump.conf
        dest: /etc/systemd/coredump.conf
        owner: root
        group: root
        mode: 0744
        backup: yes

- name: "HARDEN_OS UBUNTU | Ensure prelink is not installed"
  block:
    - name: "Restore binaries to normal"
      ansible.builtin.command: prelink -ua
      changed_when: false
      failed_when: false

    - name: "Remove prelink package"
      ansible.builtin.package:
        name: prelink
        state: absent
        purge: false

- name: "HARDEN_OS UBUNTU | Copy over issue and issue.net warning banners"
  ansible.builtin.copy:
    src: "ubu/{{ item }}"
    dest: "/etc/{{ item }}"
    owner: root
    group: root
    mode: 0644
    backup: yes
  with_items:
    - issue
    - issue.net

- name: "HARDEN_OS UBUNTU | Disable Automatic Error Reporting"
  block:
    - name: "Disable Apport"
      ansible.builtin.copy:
        src: ubu/apport
        dest: /etc/default/apport
        owner: root
        group: root
        mode: 0744

    - name: "Remove Apport package"
      ansible.builtin.package:
        name: apport
        state: absent
        purge: false

- name: "HARDEN_OS UBUNTU | Configure MOTD"
  block:
    - name: "Set MOTD message"
      ansible.builtin.copy:
        src: ubu/motd
        dest: /etc/motd
        owner: root
        group: root
        mode: 0644

    - name: "Disable dynamic_motd/pam_motd.so"
      ansible.builtin.copy:
        src: ubu/sshd
        dest: /etc/pam.d/sshd

- name: "HARDEN_OS UBUNTU | Configure local login warning banner"
  block:
    - name: "Set local MOTD in /etc/issue"
      ansible.builtin.lineinfile:
        path: /etc/issue
        insertafter: '.'
        line: ' \n This system is for AUTHORIZED use only! Violators will be prosecuted under the fullest extent of the law. '
        backup: yes
        owner: root
        group: root
        mode: 0644

    - name: "Divert /etc/issue with dpkg"
      community.general.dpkg_divert:
        path: /etc/issue

- name: "HARDEN_OS UBUNTU | Configure remote login warning banner"
  block:
    - name: "Set remote MOTD in /etc/issue"
      ansible.builtin.lineinfile:
        path: /etc/issue.net
        insertafter: '.'
        line: ' \n This system is for AUTHORIZED use only! Violators will be prosecuted under the fullest extent of the law. '
        backup: yes
        owner: root
        group: root
        mode: 0644

    - name: "Divert /etc/issue.net with dpkg"
      community.general.dpkg_divert:
        path: /etc/issue.net

- name: "HARDEN_OS UBUNTU | Make root own /etc/motd"
  ansible.builtin.file:
    path: /etc/motd
    owner: root
    group: root
    mode: 0644

- name: "HARDEN_OS UBUNTU | Make root own /etc/issue"
  ansible.builtin.file:
    path: /etc/issue
    owner: root
    group: root
    mode: 0644

- name: "HARDEN_OS UBUNTU | Make root own /etc/issue.net"
  ansible.builtin.file:
    path: /etc/issue.net
    owner: root
    group: root
    mode: 0644

- name: "HARDEN_OS UBUNTU | Ensure GDM is removed"
  ansible.builtin.package:
    name: gdm3
    state: absent

- name: HARDEN_OS UBUNTU | Discover dconf systemdb
  ansible.builtin.shell: grep system-db /etc/dconf/profile/user | cut -d ':' -f2
  changed_when: false
  failed_when: prelim_dconf_system_db.rc not in [ 0, 1 ]
  register: prelim_dconf_system_db

- name: "HARDEN_OS UBUNTU | Disable IPv6"
  block:
    - name: "Copy GRUB config"
      ansible.builtin.copy:
        src: ubu/grub
        dest: /etc/default/grub
        owner: root
        group: root
        mode: 0644

    - name: "Update GRUB"
      ansible.builtin.command: update-grub

- name: "HARDEN_OS UBUNTU | Disable wireless interfaces"
  block:
    - name: "Check for network-manager tool"
      ansible.builtin.command: nmcli radio wifi
      changed_when: false
      failed_when: false
      check_mode: false
      register: discovered_wifi_status
      when: "'network-manager' in ansible_facts.packages"

    - name: "Disable wireless if network-manager installed"
      ansible.builtin.command: nmcli radio all off
      changed_when: discovered_nmcli_radio_off.rc == 0
      register: discovered_nmcli_radio_off
      when:
        - "'network-manager' in ansible_facts.packages"
        - "'enabled' in discovered_wifi_status.stdout"

    - name: "Warn about wireless if network-manager not installed"
      ansible.builtin.debug:
        msg: "Warning!! You need to disable wireless interfaces manually since network-manager is not installed"
      when: "'network-manager' not in ansible_facts.packages"

- name: "HARDEN_OS UBUNTU | Remove Bluetooth"
  ansible.builtin.package:
    name: bluez
    state: absent

- name: HARDEN_OS UBUNTU | Modprobe stuff
  block:
  - name: Replace dccp.conf with ours"
    ansible.builtin.copy:
      src: ubu/modprobe.d/dccp.conf
      dest: /etc/modprobe.d/dccp.conf
      owner: root
      group: root
      mode: 0744
      backup: yes

  - name: Replace blacklist.conf with ours
    ansible.builtin.copy:
      src: ubu/modprobe.d/blacklist.conf
      dest: /etc/modprobe.d/blacklist.conf
      owner: root
      group: root
      mode: 0744
      backup: yes

  - name: Replace tipc.conf with ours
    ansible.builtin.copy:
      src: ubu/modprobe.d/tipc.conf
      dest: /etc/modprobe.d/tipc.conf
      owner: root
      group: root
      mode: 0744

  - name: Replace rds.conf with ours
    ansible.builtin.copy:
      src: ubu/modprobe.d/rds.conf
      dest: /etc/modprobe.d/rds.conf
      owner: root
      group: root
      mode: 0744
      backup: yes

  - name: Replace sctp.conf with ours
    ansible.builtin.copy:
      src: ubu/modprobe.d/sctp.conf
      dest: /etc/modprobe.d/sctp.conf
      owner: root
      group: root
      mode: 0744
      backup: yes

- name: HARDEN_OS UBUNTU | Sudoers
  ansible.builtin.copy:
    src: ubu/sudoers
    dest: /etc/sudoers
    owner: root
    group: root
    mode: 0744
    backup: yes
  
# TODO: Move to audit? also write to audit file?
- name: HARDEN_OS UBUNTU | Get non-root UID 0 accounts
  ansible.builtin.shell: "cat /etc/passwd | awk -F: '($3 == 0 && $1 != \"root\") {i++;print $1 } END {exit i}'"
  changed_when: false
  check_mode: false
  register: prelim_uid_zero_accounts_except_root

- name: "HARDEN_OS UBUNTU | Remove non-root UID 0 accounts"
  ansible.builtin.command: passwd -l {{ item }}
  changed_when: false
  failed_when: false
  loop: "{{ prelim_uid_zero_accounts_except_root.stdout_lines }}"

- name: "HARDEN_OS UBUNTU | Get non-root members of GID 0"
  ansible.builtin.shell: "awk -F: '($1 !~ /^(sync|shutdown|halt|operator)/ && $4==\"0\") {print $1}' /etc/passwd | grep -wv 'root'"
  changed_when: false
  failed_when: discovered_gid0_members.rc not in [ 0, 1 ]
  register: discovered_gid0_members

- name: "HARDEN_OS UBUNTU | Remove non-root members of GID 0"
  ansible.builtin.user:
    name: "{{ item }}"
    group: root
    state: absent
  loop: "{{ discovered_gid0_members.stdout_lines }}"
  when:
    - discovered_gid0_members is defined
    - discovered_gid0_members.stdout | length > 0

- name: "HARDEN_OS UBUNTU | Drop in login.defs"
  ansible.builtin.copy:
    src: "ubu/login.defs"
    dest: "/etc/login.defs"
    owner: root
    group: root
    mode: 0644
    backup: yes

- name: "HARDEN_OS UBUNTU | PAM settings"
  block:
    - name: "Drop in common-* files"
      ansible.builtin.copy:
        src: "ubu/pam.d/{{ item }}"
        dest: /etc/pam.d/{{ item }}
        owner: root
        group: root
        mode: 0644
        backup: yes
      with_items:
        - common-auth
        - common-account
        - common-password
        - common-session
        - common-session-noninteractive

    - name: "Drop in module configuration files"
      ansible.builtin.copy:
        src: "ubu/security/{{ item }}"
        dest: "/etc/security/{{ item }}"
        owner: root
        group: root
        mode: 0644
        backup: yes
      with_items:
        - pwquality.conf
        - access.conf
        - pwhistory.conf
        - faillock.conf

# TODO: move to audit?
- name: "HARDEN_OS UBUNTU | Check to see if root has a password"
  ansible.builtin.shell: passwd -S root | grep -E "root P"
  changed_when: false
  failed_when: false
  register: root_passwd_set

- name: "HARDEN_OS UBUNTU | Yell that root doesn't have a password"
  ansible.builtin.assert:
    that: root_passwd_set.rc == 0
    fail_msg: "You have rule 5.4.2.4 enabled this requires that you have a root password set - Please manually set a root password"
    success_msg: "You have a root password set"
  ignore_errors: yes

# TODO: move to audit?
- name: "HARDEN_OS UBUNTU | Ensure root PATH Integrity"
  block:
    - name: "HARDEN_OS UBUNTU | Get root paths"
      ansible.builtin.shell: sudo -Hiu root env | grep '^PATH' | cut -d= -f2
      changed_when: false
      register: discovered_root_paths

    - name: "HARDEN_OS UBUNTU | Get root paths"
      ansible.builtin.shell: sudo -Hiu root env | grep '^PATH' | cut -d= -f2 | tr ":" "\n"
      changed_when: false
      register: discovered_root_paths_split
      when: discovered_root_paths is defined

    - name: "HARDEN_OS UBUNTU | Set fact"
      ansible.builtin.set_fact:
        root_paths: "{{ discovered_root_paths.stdout }}"
      when: discovered_root_paths is defined

    - name: "HARDEN_OS UBUNTU | Check for empty dirs"
      ansible.builtin.shell: 'echo {{ root_paths }} | grep -q "::" && echo "roots path contains a empty directory (::)"'
      changed_when: false
      failed_when: discovered_root_path_empty_dir.rc not in [ 0, 1 ]
      register: discovered_root_path_empty_dir
      when: discovered_root_paths is defined

    - name: "HARDEN_OS UBUNTU | Check for trailing ':'"
      ansible.builtin.shell: "echo {{ root_paths }} | grep -q \":$\" && echo \"roots path contains a trailing (:)\""
      changed_when: false
      failed_when: discovered_root_path_trailing_colon.rc not in [ 0, 1 ]
      register: discovered_root_path_trailing_colon
      when: discovered_root_paths is defined

    - name: "HARDEN_OS UBUNTU | Ensure root PATH Integrity | Check for owner and permissions"
      block:
        - name: "HARDEN_OS UBUNTU | Check for owner and permissions"
          ansible.builtin.stat:
            path: "{{ item }}"
          register: discovered_root_path_perms
          loop: "{{ discovered_root_paths_split.stdout_lines }}"

        - name: "HARDEN_OS UBUNTU | Set permissions"
          ansible.builtin.file:
            path: "{{ item.stat.path }}"
            state: directory
            owner: root
            group: root
            mode: 0755
            follow: false
          loop: "{{ discovered_root_path_perms.results }}"
          loop_control:
            label: "{{ item }}"
          when:
            - item.stat.exists
            - item.stat.isdir
            - item.stat.pw_name != 'root' or item.stat.gr_name != 'root' or item.stat.woth or item.stat.wgrp
            - (item != 'root')
      when: discovered_root_paths is defined
  ignore_errors: yes

- name: "HARDEN_OS UBUNTU | Replace all bash profiles with with ours"
  block:
    - name: "HARDEN_OS UBUNTU | ROOT BASH | Replace bash_profile"
      ansible.builtin.copy:
        src: ubu/skel/root_bash_profile
        dest: /root/.bash_profile
        owner: root
        group: root
        mode: 0744
        backup: yes

    - name: "HARDEN_OS UBUNTU | ROOT BASH | Replace bashrc"
      ansible.builtin.copy:
        src: ubu/skel/root_bashrc
        dest: /root/.bashrc
        owner: root
        group: root
        mode: 0744
        backup: yes

    - name: "HARDEN_OS UBUNTU | ROOT BASH | Replace bash_login"
      ansible.builtin.copy:
        src: ubu/skel/bash_login
        dest: /root/.bash_login
        owner: root
        group: root
        mode: 0744
        backup: yes

    - name: "HARDEN_OS UBUNTU | ROOT BASH | Replace bash_logout"
      ansible.builtin.copy:
        src: ubu/skel/bash_logout
        dest: /root/.bash_logout
        owner: root
        group: root
        mode: 0744
        backup: yes

    - name: "HARDEN_OS UBUNTU | USER BASH | Get Home directories"
      ansible.builtin.shell: |
        awk -F: '($1 != "sync" && $1 != "root" && $7 != "/usr/sbin/nologin" && $7 != "/bin/false") {print $6}' /etc/passwd
      changed_when: false
      register: discovered_user_homes

    # TODO FIX

    - name: HARDEN_OS UBUNTU | USER BASH | Get user/group info for home directories
      ansible.builtin.stat:
        path: "{{ item }}"
      register: home_stat
      loop: "{{ discovered_user_homes.stdout_lines }}"

    - name: HARDEN_OS UBUNTU | USER BASH | Loop over home directories
      block:
        - name: "HARDEN_OS UBUNTU | USER BASH | Replace Bash Profile"
          ansible.builtin.copy:
            src: ubu/skel/bash_profile
            dest: "{{ item.0 }}/.bash_profile"
            owner: "{{ item.1.stat.pw_name }}"
            group: "{{ item.1.stat.gr_name }}"
            mode: 0744
            backup: yes
          loop: "{{ discovered_user_homes.stdout_lines | zip(home_stat.results) | list }}"
        
        - name: "HARDEN_OS UBUNTU | USER BASH | Replace bashrc"
          ansible.builtin.copy:
            src: ubu/skel/user_bashrc
            dest: "{{ item.0 }}/.bashrc"
            owner: "{{ item.1.stat.pw_name }}"
            group: "{{ item.1.stat.gr_name }}"
            mode: 0744
            backup: yes
          loop: "{{ discovered_user_homes.stdout_lines | zip(home_stat.results) | list }}"

        - name: "HARDEN_OS UBUNTU | USER BASH | Replace bash_login"
          ansible.builtin.copy:
            src: ubu/skel/bash_login
            dest: "{{ item.0 }}/.bash_login"
            owner: "{{ item.1.stat.pw_name }}"
            group: "{{ item.1.stat.gr_name }}"
            mode: 0744
            backup: yes
          loop: "{{ discovered_user_homes.stdout_lines | zip(home_stat.results) | list }}"
        
        - name: "HARDEN_OS UBUNTU | USER BASH | Replace bash_logout"
          ansible.builtin.copy:
            src: ubu/skel/bash_logout
            dest: "{{ item.0 }}/.bash_logout"
            owner: "{{ item.1.stat.pw_name }}"
            group: "{{ item.1.stat.gr_name }}"
            mode: 0744
            backup: yes
          loop: "{{ discovered_user_homes.stdout_lines | zip(home_stat.results) | list }}"
      when: discovered_user_homes is defined

    - name: "HARDEN_OS UBUNTU | SKEL BASH | Replace bash_login"
      ansible.builtin.copy:
        src: ubu/skel/bash_login
        dest: "/etc/skel/.bash_login"
        owner: root
        group: root
        mode: 0744
        backup: yes

    - name: "HARDEN_OS UBUNTU | SKEL BASH | Replace bash_logout"
      ansible.builtin.copy:
        src: ubu/skel/bash_logout
        dest: "/etc/skel/.bash_logout"
        owner: root
        group: root
        mode: 0744
        backup: yes
    
    - name: "HARDEN_OS UBUNTU | SKEL BASH | Replace bash_profile"
      ansible.builtin.copy:
        src: ubu/skel/bash_profile
        dest: "/etc/skel/.bash_profile"
        owner: root
        group: root
        mode: 0744
        backup: yes

    - name: "HARDEN_OS UBUNTU | SKEL BASH | Replace user_bashrc"
      ansible.builtin.copy:
        src: ubu/skel/user_bashrc
        dest: "/etc/skel/.bashrc"
        owner: root
        group: root
        mode: 0744
        backup: yes

    - name: "HARDEN_OS UBUNTU | SKEL BASH | Replace bash_login"
      ansible.builtin.copy:
        src: ubu/skel/profile
        dest: "/etc/skel/.profile"
        owner: root
        group: root
        mode: 0744
        backup: yes
    
    - name: "HARDEN_OS UBUNTU | SKEL BASH | Replace bash_login"
      ansible.builtin.copy:
        src: ubu/skel/bash_login
        dest: "/etc/skel/.bash_login"
        owner: root
        group: root
        mode: 0744
        backup: yes
    
    - name: "HARDEN_OS UBUNTU | Replace system_profile"
      ansible.builtin.copy:
        src: ubu/skel/system_profile
        dest: "/etc/profile"
        owner: root
        group: root
        mode: 0744
        backup: yes

    - name: "HARDEN_OS UBUNTU | Replace bashrc.bashrc"
      ansible.builtin.copy:
        src: ubu/skel/bashrc.bashrc
        dest: "/etc/bashrc.bashrc"
        owner: root
        group: root
        mode: 0744
        backup: yes

- name: "HARDEN_OS UBUNTU | Replace /etc/shells with our version"
  ansible.builtin.copy:
    src: ubu/shells
    dest: /etc/shell
    owner: root
    group: root
    mode: 0644
    backup: yes

- name: HARDEN_OS UBUNTU | Discover Interactive UID MIN and MIN from logins.def
  block:
    - name: Capture UID_MIN information from logins.def
      ansible.builtin.shell: grep -w "^UID_MIN" /etc/login.defs | awk '{print $NF}'
      changed_when: false
      register: prelim_uid_min_id

    - name: Capture UID_MAX information from logins.def
      ansible.builtin.shell: grep -w "^UID_MAX" /etc/login.defs | awk '{print $NF}'
      changed_when: false
      register: prelim_uid_max_id

    - name: Capture GID_MIN information from logins.def
      ansible.builtin.shell: grep -w "^GID_MIN" /etc/login.defs | awk '{print $NF}'
      changed_when: false
      register: prelim_gid_min_id

    - name: Set_facts for interactive uid/gid
      ansible.builtin.set_fact:
        min_int_uid: "{{ prelim_uid_min_id.stdout }}"
        max_int_uid: "{{ prelim_uid_max_id.stdout }}"
        min_int_gid: "{{ prelim_gid_min_id.stdout }}"

- name: HARDEN_OS UBUNTU | Secure /etc/passwd
  block:
    - name: Get Interactive Users
      ansible.builtin.shell: >
        grep -E -v '^(root|halt|sync|shutdown)' /etc/passwd | awk -F: '(!index($7, "sbin/nologin") && $7 != "/bin/nologin" && $7 != "/bin/false" && $7 != "/dev/null") { print $1 }'
      changed_when: false
      register: prelim_interactive_usernames

    - name: "Parse /etc/passwd"
      block:
        - name: "Parse /etc/passwd | Get /etc/passwd contents"
          ansible.builtin.command: cat /etc/passwd
          changed_when: false
          check_mode: false
          register: prelim_passwd_file_audit

        - name: "Parse /etc/passwd | Split passwd entries"
          ansible.builtin.set_fact:
            ubu22_passwd: "{{ prelim_passwd_file_audit.stdout_lines | map('regex_replace', ld_passwd_regex, ld_passwd_yaml) | map('from_yaml') | list }}"

          with_items: "{{ prelim_passwd_file_audit.stdout_lines }}"
          vars:
            ld_passwd_regex: >-
              ^(?P<id>[^:]*):(?P<password>[^:]*):(?P<uid>[^:]*):(?P<gid>[^:]*):(?P<gecos>[^:]*):(?P<dir>[^:]*):(?P<shell>[^:]*)
            ld_passwd_yaml: |  # pragma: allowlist secret
              id: >-4
                  \g<id>
              password: >-4
                  \g<password>
              uid: \g<uid>
              gid: \g<gid>
              gecos: >-4
                  \g<gecos>
              dir: >-4
                  \g<dir>
              shell: >-4
                  \g<shell>

    - name: "Ensure system accounts do not have a valid login shell"
      ansible.builtin.user:
        name: "{{ item.id }}"
        shell: /usr/sbin/nologin
      loop: "{{ ubu22_passwd }}"
      loop_control:
        label: "{{ item.id }}"
      when:
        - "item.id not in prelim_interactive_usernames.stdout"
        - "'root' not in item.id"

    - name: "Ensure accounts without a valid login shell are locked | Lock accounts"
      ansible.builtin.user:
        name: "{{ item.id }}"
        password_lock: true
      loop: "{{ ubu22_passwd }}"
      loop_control:
        label: "{{ item.id }}"
      when:
        - "item.id not in prelim_interactive_usernames.stdout"
        - "'root' not in item.id"

    - name: "Create home dir if absent"
      ansible.builtin.file:  # noqa risky-file-permissions
        path: "{{ item.dir }}"
        state: directory
        owner: "{{ item.id }}"
        group: "{{ item.gid }}"
      loop: "{{ ubu22_passwd | selectattr('uid', '>=', min_int_uid | int) | selectattr('uid', '<=', max_int_uid | int) | list }}"
      loop_control:
        label: "{{ item.id }}"
      ignore_errors: yes

- name: "HARDEN_OS UBUNTU | Replace /etc/systemd/journald.conf with our version"
  ansible.builtin.copy:
    src: ubu/journald.conf
    dest: /etc/systemd/journald.conf
    owner: root
    group: root
    mode: 0644
    backup: yes

- name: "HARDEN_OS UBUNTU | Ensure journald service is enabled and active"
  ansible.builtin.systemd:
    name: systemd-journald.service
    masked: false
    state: started

- name: "HARDEN_OS UBUNTU | Ensure access to all logfiles has been configured"
  block:
    - name: "Discover all system log files"
      ansible.builtin.find:
        paths: /var/log
        file_type: file
      register: log_files
    
    - name: DEBUGGGGGG
      ansible.builtin.debug:
        msg: "{{ log_files }}"

    - name: DEBUGGGGGG
      ansible.builtin.debug:
        msg: "{{ log_files.files }}"

    - name: "Set permissions on log files (660 for tmp, lastlog, sssd, 640 otherwise)"
      ansible.builtin.file:
        path: "{{ item.path }}"
        mode: "{{ 
          (item.path | regex_search('(.*/(btmp|utmp|wtmp|lastlog.*|.*tmp))$')) 
              | ternary('0660', '0640') 
          }}"
        loop: "{{ log_files.files }}"
        when: item.path not in [
                '/var/log/btmp',
                '/var/log/utmp',
                '/var/log/wtmp',
                '/var/log/lastlog'
            ]
  ignore_errors: yes

- name: "HARDEN_OS UBUNTU | Set file permissions of 644 files"
  ansible.builtin.file:
    path: "{{ item }}"
    owner: root
    group: root
    mode: 0644
  with_items:
    - /etc/passwd
    - /etc/passwd-
    - /etc/group
    - /etc/group-
  ignore_errors: yes # If file doesn't exist, don't fatal error (mainly for hyphenated files)

- name: "HARDEN_OS UBUNTU | Set file permissions of 640 files"
  ansible.builtin.file:
    path: "{{ item }}"
    owner: root
    group: root
    mode: 0640
  with_items:
    - /etc/shadow
    - /etc/shadow-
    - /etc/gshadow
    - /etc/gshadow-
  ignore_errors: yes # If file doesn't exist, don't fatal error (mainly for hyphenated files)

- name: "HARDEN_OS UBUNTU | Set file permissions of 600 files"
  ansible.builtin.file:
    path: "{{ item }}"
    owner: root
    group: root
    mode: 0600
  with_items:
    - /etc/security/opasswd
    - /etc/security/opasswd.old
  ignore_errors: yes # If file doesn't exist, don't fatal error

- name: "HARDEN_OS UBUNTU | Lock users with empty passwords"
  block:
    - name: "Find users with no password"
      ansible.builtin.shell: awk -F":" '($2 == "" ) { print $1 }' /etc/shadow
      changed_when: false
      check_mode: false
      register: discovered_empty_password_acct

    - name: "Lock users with empty password"
      ansible.builtin.user:
        name: "{{ item }}"
        password_lock: true
      loop:
        - "{{ discovered_empty_password_acct.stdout_lines }}"
      when: discovered_empty_password_acct.stdout | length > 0

- name: HARDEN_OS UBUNTU | Secure SSHd
  block:
    - name: "Replace sshd_config with our version"
      ansible.builtin.copy:
        src: ubu/sshd_config
        dest: /etc/ssh/sshd_config
        owner: root
        group: root
        mode: 0644
        backup: yes

    - name: "Restart sshd"
      ansible.builtin.systemd_service:
        name: "{{ item }}"
        enabled: yes
        state: restarted
        masked: false
      with_items: 
        - ssh
        - sshd
      ignore_errors: true