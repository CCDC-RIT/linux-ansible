- name: "HARDEN_OS RHEL | Configure MOTD"
  block:
    - name: "Set MOTD message"
      ansible.builtin.copy:
        src: rhel/motd
        dest: /etc/motd
        owner: root
        group: root
        mode: 0644

    - name: "Disable dynamic_motd/pam_motd.so"
      ansible.builtin.copy:
        src: rhel/sshd
        dest: /etc/pam.d/sshd

- name: "HARDEN_OS RHEL | Configure local login warning banner"
  block:
    - name: "Set local MOTD in /etc/issue"
      ansible.builtin.lineinfile:
        path: /etc/issue
        insertafter: '.'
        line: ' \n This system is for AUTHORIZED use only! Violators will be prosecuted under the fullest extent of the law. '
        backup: yes
        owner: root
        group: root
        mode: 0644

    - name: "Divert /etc/issue with dpkg"
      community.general.dpkg_divert:
        path: /etc/issue

- name: "HARDEN_OS RHEL | Configure remote login warning banner"
  block:
    - name: "Set remote MOTD in /etc/issue"
      ansible.builtin.lineinfile:
        path: /etc/issue.net
        insertafter: '.'
        line: ' \n This system is for AUTHORIZED use only! Violators will be prosecuted under the fullest extent of the law. '
        backup: yes
        owner: root
        group: root
        mode: 0644

    - name: "Divert /etc/issue.net with dpkg"
      community.general.dpkg_divert:
        path: /etc/issue.net

- name: "HARDEN_OS RHEL | Make root own /etc/motd"
  ansible.builtin.file:
    path: /etc/motd
    owner: root
    group: root
    mode: 0644

- name: "HARDEN_OS RHEL | Make root own /etc/issue"
  ansible.builtin.file:
    path: /etc/issue
    owner: root
    group: root
    mode: 0644

- name: "HARDEN_OS RHEL | Make root own /etc/issue.net"
  ansible.builtin.file:
    path: /etc/issue.net
    owner: root
    group: root
    mode: 0644

- name: "HARDEN_OS RHEL | Secure IPv4 and IPv6 and restrict core dumps"
  block:
      # TODO: Create exclusion for kube
    - name: "Replace sysctl.conf with ours"
      ansible.builtin.copy:
        src: rhel/sysctl.conf
        dest: /etc/sysctl.conf
        owner: root
        group: root
        mode: 0744
        backup: yes

    - name: "Replace coredump.conf with ours"
      ansible.builtin.copy:
        src: rhel/coredump.conf
        dest: /etc/systemd/coredump.conf
        owner: root
        group: root
        mode: 0744
        backup: yes

- name: "HARDEN_OS RHEL | Ensure cron daemon is enabled"
  ansible.builtin.service:
    name: crond
    enabled: true

- name: "HARDEN_OS RHEL | Configure cron permissions"
  block:
    - name: "HARDEN_OS RHEL | Set permissions on /etc/crontab"
      ansible.builtin.file:
        path: /etc/crontab
        owner: root
        group: root
        mode: 0700

    - name: "HARDEN_OS RHEL | Set permissions on /etc/cron.hourly"
      ansible.builtin.file:
        path: /etc/cron.hourly
        state: directory
        owner: root
        group: root
        mode: 0700

    - name: "HARDEN_OS RHEL | Set permissions on /etc/cron.daily"
      ansible.builtin.file:
        path: /etc/cron.daily
        state: directory
        owner: root
        group: root
        mode: 0700

    - name: "HARDEN_OS RHEL | Set permissions on /etc/cron.weekly"
      ansible.builtin.file:
        path: /etc/cron.weekly
        state: directory
        owner: root
        group: root
        mode: 0700

    - name: "HARDEN_OS RHEL | Set permissions on /etc/cron.monthly"
      ansible.builtin.file:
        path: /etc/cron.monthly
        state: directory
        owner: root
        group: root
        mode: 0700

    - name: "HARDEN_OS RHEL | Set permissions on /etc/cron.d"
      ansible.builtin.file:
        path: /etc/cron.d
        state: directory
        owner: root
        group: root
        mode: 0700

- name: "HARDEN_OS RHEL | Ensure bluetooth services are not in use"
  ansible.builtin.package:
    name: bluez
    state: absent

- name: HARDEN_OS RHEL | Modprobe stuff
  block:
  - name: Replace dccp.conf with ours"
    ansible.builtin.copy:
      src: rhel/modprobe.d/dccp.conf
      dest: /etc/modprobe.d/dccp.conf
      owner: root
      group: root
      mode: 0744
      backup: yes

  - name: Replace blacklist.conf with ours
    ansible.builtin.copy:
      src: rhel/modprobe.d/blacklist.conf
      dest: /etc/modprobe.d/blacklist.conf
      owner: root
      group: root
      mode: 0744
      backup: yes

  - name: Replace tipc.conf with ours
    ansible.builtin.copy:
      src: rhel/modprobe.d/tipc.conf
      dest: /etc/modprobe.d/tipc.conf
      owner: root
      group: root
      mode: 0744

  - name: Replace rds.conf with ours
    ansible.builtin.copy:
      src: rhel/modprobe.d/rds.conf
      dest: /etc/modprobe.d/rds.conf
      owner: root
      group: root
      mode: 0744
      backup: yes

  - name: Replace sctp.conf with ours
    ansible.builtin.copy:
      src: rhel/modprobe.d/sctp.conf
      dest: /etc/modprobe.d/sctp.conf
      owner: root
      group: root
      mode: 0744
      backup: yes

- name: HARDEN_OS RHEL | Sudoers
  ansible.builtin.copy:
    src: rhel/sudoers
    dest: /etc/sudoers
    owner: root
    group: root
    mode: 0744
    backup: yes

- name: "HARDEN_OS RHEL | Ensure permissions on /etc/ssh/sshd_config are configured"
  ansible.builtin.file:
    path: "/etc/ssh/sshd_config"
    owner: root
    group: root
    mode: 'go-rwx'

- name: "HARDEN_OS RHEL | Ensure permissions on SSH private host key files are configured"
  block:
    - name: "5.1.2 | Find the SSH private host keys"
      ansible.builtin.find:
        paths: /etc/ssh
        patterns: 'ssh_host_*_key'
        recurse: true
        file_type: any
      register: discovered_ssh_private_host_key

    - name: "HARDEN_OS RHEL | Set permissions on SSH private host keys"
      ansible.builtin.file:
        path: "{{ item.path }}"
        owner: root
        group: root
        mode: 'u-x,go-rwx'
      loop: "{{ discovered_ssh_private_host_key.files }}"
      loop_control:
        label: "{{ item.path }}"

- name: "HARDEN_OS RHEL | Ensure permissions on SSH public host key files are configured"
  block:
    - name: "HARDEN_OS RHEL | Find the SSH public host keys"
      ansible.builtin.find:
        paths: /etc/ssh
        patterns: 'ssh_host_*_key.pub'
        recurse: true
        file_type: any
      register: discovered_ssh_public_host_key

    - name: "HARDEN_OS RHEL | Set permissions on SSH public host keys"
      ansible.builtin.file:
        path: "{{ item.path }}"
        owner: root
        group: root
        mode: 'u-x,go-wx'
      loop: "{{ discovered_ssh_public_host_key.files }}"
      loop_control:
        label: "{{ item.path }}"

- name: "HARDEN_OS RHEL | Ensure sudo is installed"
  ansible.builtin.package:
    name: sudo
    state: present

- name: "HARDEN_OS RHEL | Ensure sudo commands use pty"
  ansible.builtin.lineinfile:
    path: /etc/sudoers
    line: "Defaults    use_pty"
    validate: '/usr/sbin/visudo -cf %s'

- name: "HARDEN_OS RHEL | Ensure sudo log file exists"
  ansible.builtin.lineinfile:
    path: /etc/sudoers
    regexp: '^Defaults    logfile='
    line: 'Defaults    logfile="{{ sudolog_location }}"'
    validate: '/usr/sbin/visudo -cf %s'

- name: "HARDEN_OS RHEL | Ensure users must provide password for escalation"
  block:
    - name: "HARDEN_OS RHEL | Discover accounts with NOPASSWD"
      ansible.builtin.shell: grep -Ei '(nopasswd)' /etc/sudoers /etc/sudoers.d/* | cut -d':' -f1
      become: true
      changed_when: false
      failed_when: false
      register: discovered_nopasswd_sudoers

    - name: "HARDEN_OS RHEL | Remove nopasswd for accounts not excluded"
      ansible.builtin.replace:
        path: "{{ item }}"
        regexp: '^((?!#|{% for name in sudoers_exclude_nopasswd_list %}{{ name }}{% if not loop.last -%}|{%- endif -%}{% endfor %}).*)NOPASSWD(.*)'
        replace: '\1PASSWD\2'
        validate: '/usr/sbin/visudo -cf %s'
      loop: "{{ discovered_nopasswd_sudoers.stdout_lines }}"
      when: discovered_nopasswd_sudoers.stdout | length > 0

- name: "HARDEN_OS RHEL | Ensure re-authentication for privilege escalation is not disabled globally"
  block:
    - name: "5.2.5"
      ansible.builtin.shell: grep -Ei '(!authenticate)' /etc/sudoers /etc/sudoers.d/* | cut -d':' -f1
      become: true
      changed_when: false
      failed_when: false
      register: discovered_priv_reauth

    - name: "5.2.5"
      ansible.builtin.replace:
        path: "{{ item }}"
        regexp: '^([^#].*)!authenticate(.*)'
        replace: '\1authenticate\2'
        validate: '/usr/sbin/visudo -cf %s'
      loop: "{{ discovered_priv_reauth.stdout_lines }}"
      when: discovered_priv_reauth.stdout | length > 0
  when: rule_5_2_5




- name: Restart sshd
  ansible.builtin.systemd:
    name: sshd
    state: restarted

- name: Systemd daemon reload
  ansible.builtin.systemd:
    daemon-reload: true

- name: Authselect update
  ansible.builtin.command: authselect apply-changes
  changed_when: true

- name: Restart journald
  ansible.builtin.systemd:
    name: systemd-journald
    state: restarted

- name: HARDEN_OS RHEL | Secure SSHd
  block:
    - name: "Replace sshd_config with our version"
      ansible.builtin.copy:
        src: rhel/sshd_config
        dest: /etc/ssh/sshd_config
        owner: root
        group: root
        mode: 0644
        backup: yes

    - name: "Restart sshd"
      ansible.builtin.systemd:
        name: sshd
        enabled: yes
        state: restarted
        masked: no

- name: "HARDEN_OS RHEL | Ensure journald service is enabled and active"
  ansible.builtin.systemd:
    name: systemd-journald.service
    masked: false
    state: started
  when: rule_6_2_1_1

- name: "HARDEN_OS RHEL | Ensure journald log file access is configured"
  block:
    - name: "Default file permissions"
      ansible.builtin.file:
        path: /usr/lib/tmpfiles.d/systemd.conf
        mode: 0740

    - name: "Check for override file"
      ansible.builtin.stat:
        path: /etc/tmpfiles.d/systemd.conf
      register: discovered_tmpfile_override

    - name: "If override file check for journal"
      ansible.builtin.shell: grep -E 'z /var/log/journal/%m/system.journal \d*' /usr/lib/tmpfiles.d/systemd.conf
      register: discovered_journald_fileperms_override
      changed_when: false
      failed_when: discovered_journald_fileperms_override.rc not in [ 0, 1 ]
      when: discovered_tmpfile_override.stat.exists

    - name: "Warning if override found"
      ansible.builtin.debug:
        msg: "Warning!! - tmpfiles override found /usr/lib/tmpfiles.d/systemd.conf affecting journald files please confirm matches site policy"
      when:
        - discovered_tmpfile_override.stat.exists
        - discovered_journald_fileperms_override.stdout | length > 0

- name: "HARDEN_OS RHEL | ensure /etc/systemd/journal.conf.d exists"
  ansible.builtin.file:
    path: /etc/systemd/journald.conf.d
    state: directory
    mode: 0755
    owner: root
    group: root

- name: "HARDEN_OS RHEL | Ensure journald log file rotation is configured"
  block:
    - name: "Add file"
      ansible.builtin.template:
        src: "rhel/rotation.conf"
        dest: /etc/systemd/journald.conf.d/rotation.conf
        owner: root
        group: root
        mode: 0740

# TODO replace with a default journald
    - name: "6.2.1.3 | comment out current entries"
      ansible.builtin.replace:
        path: /etc/systemd/journald.conf
        regexp: "{{ item }}"
        replace: '#\1'
      loop:
        - '^(\s*SystemMaxUse\s*=.*)'
        - '^(\s*SystemKeepFree\s*=.*)'
        - '^(\s*RuntimeMaxUse\s*=)'
        - '^(\s*RuntimeKeepFree\s*=.*)'
        - '^(\s*MaxFileSec\s*=.*)'

- name: "HARDEN_OS RHEL | Gather UID 0 accounts other than root"
  ansible.builtin.shell: "cat /etc/passwd | awk -F: '($3 == 0 && $1 != \"root\") {i++;print $1 } END {exit i}'"
  changed_when: false
  check_mode: false
  register: uid_zero_accounts_except_root

- name: "HARDEN_OS RHEL | Ensure root is the only UID 0 account"
  ansible.builtin.command: passwd -l {{ item }}
  changed_when: false
  failed_when: false
  loop: "{{ uid_zero_accounts_except_root.stdout_lines }}"

- name: "HARDEN_OS RHEL | Ensure root is the only GID 0 account"
  block:
    - name: "HARDEN_OS RHEL | Get members of gid 0"
      ansible.builtin.shell: "awk -F: '($1 !~ /^(sync|shutdown|halt|operator)/ && $4==\"0\") {print $1}' /etc/passwd | grep -wv 'root'"
      register: discovered_gid0_members
      changed_when: false
      failed_when: discovered_gid0_members.rc not in [ 0, 1 ]

    - name: "HARDEN_OS RHEL | Remove users not root from gid 0"
      ansible.builtin.user:
        name: "{{ item }}"
        group: root
        state: absent
      loop: "{{ discovered_gid0_members.stdout_lines }}"
      when:
        - discovered_gid0_members is defined
        - discovered_gid0_members.stdout | length > 0

- name: "HARDEN_OS RHEL | Replace all bash profiles with with ours"
  block:
    - name: "HARDEN_OS RHEL | ROOT BASH | Replace bash_profile"
      ansible.builtin.copy:
        src: rhel/skel/root_bash_profile
        dest: /root/.bash_profile
        owner: root
        group: root
        mode: 0744
        backup: yes

    - name: "HARDEN_OS RHEL | ROOT BASH | Replace bashrc"
      ansible.builtin.copy:
        src: rhel/skel/root_bashrc
        dest: /root/.bashrc
        owner: root
        group: root
        mode: 0744
        backup: yes

    - name: "HARDEN_OS RHEL | ROOT BASH | Replace bash_login"
      ansible.builtin.copy:
        src: rhel/skel/bash_login
        dest: /root/.bash_login
        owner: root
        group: root
        mode: 0744
        backup: yes

    - name: "HARDEN_OS RHEL | ROOT BASH | Replace bash_logout"
      ansible.builtin.copy:
        src: rhel/skel/bash_logout
        dest: /root/.bash_logout
        owner: root
        group: root
        mode: 0744
        backup: yes

    - name: "HARDEN_OS RHEL | USER BASH | Get Home directories"
      ansible.builtin.shell: |
        awk -F: '($1 != "sync" && $1 != "root" && $7 != "/usr/sbin/nologin" && $7 != "/bin/false") {print $6}' /etc/passwd
      changed_when: false
      register: discovered_user_homes

    # TODO FIX

    - name: HARDEN_OS RHEL | USER BASH | Get user/group info for home directories
      ansible.builtin.stat:
        path: "{{ item }}"
      register: home_stat
      loop: "{{ discovered_user_homes.stdout_lines }}"

    - name: HARDEN_OS RHEL | USER BASH | Loop over home directories
      block:
        - name: "HARDEN_OS RHEL | USER BASH | Replace Bash Profile"
          ansible.builtin.copy:
            src: rhel/skel/bash_profile
            dest: "{{ item.0 }}/.bash_profile"
            owner: "{{ item.1.stat.pw_name }}"
            group: "{{ item.1.stat.gr_name }}"
            mode: 0744
            backup: yes
          loop: "{{ discovered_user_homes.stdout_lines | zip(home_stat.results) | list }}"
        
        - name: "HARDEN_OS RHEL | USER BASH | Replace bashrc"
          ansible.builtin.copy:
            src: rhel/skel/user_bashrc
            dest: "{{ item.0 }}/.bashrc"
            owner: "{{ item.1.stat.pw_name }}"
            group: "{{ item.1.stat.gr_name }}"
            mode: 0744
            backup: yes
          loop: "{{ discovered_user_homes.stdout_lines | zip(home_stat.results) | list }}"

        - name: "HARDEN_OS RHEL | USER BASH | Replace bash_login"
          ansible.builtin.copy:
            src: rhel/skel/bash_login
            dest: "{{ item.0 }}/.bash_login"
            owner: "{{ item.1.stat.pw_name }}"
            group: "{{ item.1.stat.gr_name }}"
            mode: 0744
            backup: yes
          loop: "{{ discovered_user_homes.stdout_lines | zip(home_stat.results) | list }}"
        
        - name: "HARDEN_OS RHEL | USER BASH | Replace bash_logout"
          ansible.builtin.copy:
            src: rhel/skel/bash_logout
            dest: "{{ item.0 }}/.bash_logout"
            owner: "{{ item.1.stat.pw_name }}"
            group: "{{ item.1.stat.gr_name }}"
            mode: 0744
            backup: yes
          loop: "{{ discovered_user_homes.stdout_lines | zip(home_stat.results) | list }}"
      when: discovered_user_homes is defined

    - name: "HARDEN_OS RHEL | SKEL BASH | Replace bash_login"
      ansible.builtin.copy:
        src: rhel/skel/bash_login
        dest: "/etc/skel/.bash_login"
        owner: root
        group: root
        mode: 0744
        backup: yes

    - name: "HARDEN_OS RHEL | SKEL BASH | Replace bash_logout"
      ansible.builtin.copy:
        src: rhel/skel/bash_logout
        dest: "/etc/skel/.bash_logout"
        owner: root
        group: root
        mode: 0744
        backup: yes
    
    - name: "HARDEN_OS RHEL | SKEL BASH | Replace bash_profile"
      ansible.builtin.copy:
        src: rhel/skel/bash_profile
        dest: "/etc/skel/.bash_profile"
        owner: root
        group: root
        mode: 0744
        backup: yes

    - name: "HARDEN_OS RHEL | SKEL BASH | Replace user_bashrc"
      ansible.builtin.copy:
        src: rhel/skel/user_bashrc
        dest: "/etc/skel/.bashrc"
        owner: root
        group: root
        mode: 0744
        backup: yes

    - name: "HARDEN_OS RHEL | SKEL BASH | Replace bash_login"
      ansible.builtin.copy:
        src: rhel/skel/profile
        dest: "/etc/skel/.profile"
        owner: root
        group: root
        mode: 0744
        backup: yes
    
    - name: "HARDEN_OS RHEL | SKEL BASH | Replace bash_login"
      ansible.builtin.copy:
        src: rhel/skel/bash_login
        dest: "/etc/skel/.bash_login"
        owner: root
        group: root
        mode: 0744
        backup: yes
    
    - name: "HARDEN_OS RHEL | Replace system_profile"
      ansible.builtin.copy:
        src: rhel/skel/system_profile
        dest: "/etc/profile"
        owner: root
        group: root
        mode: 0744
        backup: yes

    - name: "HARDEN_OS RHEL | Replace bashrc.bashrc"
      ansible.builtin.copy:
        src: rhel/skel/bashrc.bashrc
        dest: "/etc/bashrc.bashrc"
        owner: root
        group: root
        mode: 0744
        backup: yes

- name: "HARDEN_OS RHEL | Replace /etc/shells with our version"
  ansible.builtin.copy:
    src: rhel/shells
    dest: /etc/shell
    owner: root
    group: root
    mode: 0644
    backup: yes

- name: "HARDEN_OS RHEL | Ensure root PATH Integrity"
  block:
    - name: "HARDEN_OS RHEL | Get root paths"
      ansible.builtin.shell: sudo -Hiu root env | grep '^PATH' | cut -d= -f2
      changed_when: false
      register: discovered_root_paths

    - name: "HARDEN_OS RHEL | Get root paths"
      ansible.builtin.shell: sudo -Hiu root env | grep '^PATH' | cut -d= -f2 | tr ":" "\n"
      changed_when: false
      register: discovered_root_paths_split
      when: discovered_root_paths is defined

    - name: "HARDEN_OS RHEL | Set fact"
      ansible.builtin.set_fact:
        root_paths: "{{ discovered_root_paths.stdout }}"
      when: discovered_root_paths is defined

    - name: "HARDEN_OS RHEL | Check for empty dirs"
      ansible.builtin.shell: 'echo {{ root_paths }} | grep -q "::" && echo "roots path contains a empty directory (::)"'
      changed_when: false
      failed_when: discovered_root_path_empty_dir.rc not in [ 0, 1 ]
      register: discovered_root_path_empty_dir
      when: discovered_root_paths is defined

    - name: "HARDEN_OS RHEL | Check for trailing ':'"
      ansible.builtin.shell: '{{ root_paths }} | cut -d= -f2 | grep -q ":$" && echo "roots path contains a trailing (:)"'
      changed_when: false
      failed_when: discovered_root_path_trailing_colon.rc not in [ 0, 1 ]
      register: discovered_root_path_trailing_colon
      when: discovered_root_paths is defined

    - name: "HARDEN_OS RHEL | Check for owner and permissions"
      block:
        - name: HARDEN_OS RHEL | Check for owner and permissions"
          ansible.builtin.stat:
            path: "{{ item }}"
          register: discovered_root_path_perms
          loop: "{{ discovered_root_paths_split.stdout_lines }}"

        - name: "HARDEN_OS RHEL | Set permissions"
          ansible.builtin.file:
            path: "{{ item.stat.path }}"
            state: directory
            owner: root
            group: root
            mode: 'go-w'
            follow: false
          loop: "{{ discovered_root_path_perms.results }}"
          loop_control:
            label: "{{ item }}"
          when:
            - item.stat.exists
            - item.stat.isdir
            - item.stat.pw_name != 'root' or item.stat.gr_name != 'root' or item.stat.woth or item.stat.wgrp
            - (item != 'root')
      when: discovered_root_paths is defined

- name: "HARDEN_OS RHEL | Interactive Users"
  ansible.builtin.shell: >
    grep -E -v '^(root|halt|sync|shutdown)' /etc/passwd | awk -F: '(!index($7, "sbin/nologin") && $7 != "/bin/nologin" && $7 != "/bin/false" && $7 != "/dev/null") { print $1 }'
  changed_when: false
  register: interactive_usernames

- name: "HARDEN_OS RHEL | Ensure system accounts do not have a valid login shell"
  ansible.builtin.user:
    name: "{{ item.id }}"
    shell: /usr/sbin/nologin
  loop: "{{ passwd }}"
  loop_control:
    label: "{{ item.id }}"
  when:
    - "item.id not in interactive_usernames.stdout"
    - item.id not in system_users_shell
    - "'root' not in item.id"

- name: "HARDEN_OS RHEL | Ensure accounts without a valid login shell are locked | Lock accounts"
  ansible.builtin.user:
    name: "{{ item.id }}"
    password_lock: true
  loop: "{{ passwd }}"
  loop_control:
    label: "{{ item.id }}"
  when:
    - "item.id not in interactive_usernames.stdout"
    - "'root' not in item.id"

- name: "HARDEN_OS RHEL | Ensure systemd-journal-remote authentication is configured"
  ansible.builtin.lineinfile:
    path: /etc/systemd/journal-upload.conf
    regexp: "{{ item.regexp }}"
    line: "{{ item.line }}"
  loop:
    - { regexp: 'URL=', line: 'URL={{ remote_log_server }}'}
    - { regexp: 'ServerKeyFile=', line: 'ServerKeyFile={{ journal_upload_serverkeyfile }}'}
    - { regexp: 'ServerCertificateFile=', line: 'ServerCertificateFile={{ journal_servercertificatefile }}'}
    - { regexp: 'TrustedCertificateFile=', line: 'TrustedCertificateFile={{ journal_trustedcertificatefile }}'}

- name: "HARDEN_OS RHEL | Ensure systemd-journal-remote is enabled and active"
  ansible.builtin.systemd:
    name: systemd-journal-upload
    masked: false
    enabled: true

- name: "HARDEN_OS RHEL | Ensure systemd-journal-remote service is not in use"
  ansible.builtin.systemd:
    name: "{{ item }}"
    state: stopped
    enabled: false
    masked: true
  loop:
    - systemd-journal-remote.socket
    - systemd-journal-remote.service

- name: "HARDEN_OS UBUNTU | Set file permissions of 644 files"
  ansible.builtin.file:
    path: "{{ item }}"
    owner: root
    group: root
    mode: 0644
  with_items:
    - /etc/passwd
    - /etc/passwd-
    - /etc/group
    - /etc/group-
  ignore_errors: yes # If file doesn't exist, don't fatal error (mainly for hyphenated files)

- name: "HARDEN_OS RHEL | Set file permissions of 640 files"
  ansible.builtin.file:
    path: "{{ item }}"
    owner: root
    group: root
    mode: 0640
  with_items:
    - /etc/shadow
    - /etc/shadow-
    - /etc/gshadow
    - /etc/gshadow-
  ignore_errors: yes # If file doesn't exist, don't fatal error (mainly for hyphenated files)

- name: "HARDEN_OS RHEL | Set file permissions of 600 files"
  ansible.builtin.file:
    path: "{{ item }}"
    owner: root
    group: root
    mode: 0600
  with_items:
    - /etc/security/opasswd
    - /etc/security/opasswd.old
  ignore_errors: yes # If file doesn't exist, don't fatal error

# ADD LOGIN.DEFS REPLACE TASK HERE

# - name: HARDEN_OS RHEL | Ensure password expiration is 365 days or less
#   block:
#     - name: "Set PASS_MAX_DAYS in login.defs"
#       ansible.builtin.lineinfile:
#         path: /etc/login.defs
#         regexp: '^PASS_MAX_DAYS'
#         line: "PASS_MAX_DAYS {{ pass_max_days }}"

#     - name: "Get existing users PASS_MAX_DAYS"
#       ansible.builtin.shell: "awk -F: '(/^[^:]+:[^!*]/ && ($5> {{ pass_max_days }} || $5< {{ pass_max_days }} || $5 == -1)){print $1}' /etc/shadow"
#       changed_when: false
#       failed_when: false
#       register: discovered_max_days

#     - name: "Set existing users PASS_MAX_DAYS"
#       ansible.builtin.user:
#         name: "{{ item }}"
#         password_expire_max: "{{ pass_max_days }}"
#       loop: "{{ discovered_max_days.stdout_lines }}"
#       when:
#         - discovered_max_days.stdout_lines | length > 0
#         - item in prelim_interactive_usernames.stdout
#         - force_user_maxdays

# - name: HARDEN_OS RHEL | Ensure password expiration warning days is configured
#   block:
#     - name: HARDEN_OS RHEL | set login.defs PASS_WARN_AGE
#       ansible.builtin.lineinfile:
#         path: /etc/login.defs
#         regexp: '^PASS_WARN_AGE'
#         line: "PASS_WARN_AGE {{ pass_warn_age }}"

#     - name: HARDEN_OS RHEL | Get existing users WARN_DAYS
#       ansible.builtin.shell: "awk -F: '/^[^:]+:[^!*]/ && $6< {{ pass_warn_age }} {print $1}' /etc/shadow"
#       changed_when: false
#       failed_when: false
#       register: discovered_warn_days

#     - name: HARDEN_OS RHEL | Set existing users WARN_DAYS
#       ansible.builtin.command: "chage --warndays {{ pass['warn_age'] }} {{ item }}"
#       changed_when: true
#       loop: "{{ discovered_warn_days.stdout_lines }}"
#       when:
#         - discovered_warn_days.stdout_lines | length > 0
#         - item in prelim_interactive_usernames.stdout
#         - force_user_warnage

- name: HARDEN_OS RHEL | Ensure journald ForwardToSyslog is disabled
  block:
    - name: HARDEN_OS RHEL | Add file
      ansible.builtin.template:
        src: "{{ ansible_dir }}/rhel9/templates/etc/systemd/journald.conf.d/forwardtosyslog.conf.j2"
        dest: /etc/systemd/journald.conf.d/forwardtosyslog.conf
        owner: root
        group: root
        mode: 'g-wx,o-rwx'

    - name: HARDEN_OS RHEL | comment out current entries
      ansible.builtin.replace:
        path: /etc/systemd/journald.conf
        regexp: ^(\s*ForwardToSyslog)
        replace: '#\1'

- name: HARDEN_OS RHEL | Ensure journald Compress is configured
  block:
    - name: HARDEN_OS RHEL | Add file
      ansible.builtin.template:
        src: "{{ ansible_dir }}/rhel9/templates/etc/systemd/journald.conf.d/storage.conf.j2"
        dest: /etc/systemd/journald.conf.d/storage.conf
        owner: root
        group: root
        mode: 'g-wx,o-rwx'

    - name: HARDEN_OS RHEL | comment out current entries
      ansible.builtin.replace:
        path: /etc/systemd/journald.conf
        regexp: ^(?i)(\s*compress=)
        replace: '#\1'

- name: HARDEN_OS RHEL | Ensure journald Storage is configured
  block:
    - name: HARDEN_OS RHEL | Add file
      ansible.builtin.template:
        src: "{{ ansible_dir }}/rhel9/templates/etc/systemd/journald.conf.d/storage.conf.j2"
        dest: /etc/systemd/journald.conf.d/storage.conf
        owner: root
        group: root
        mode: 'g-wx,o-rwx'

    - name: HARDEN_OS RHEL | comment out current entries
      ansible.builtin.replace:
        path: /etc/systemd/journald.conf
        regexp: ^(?i)(\s*storage=)
        replace: '#\1'

- name: HARDEN_OS RHEL | Ensure rsyslog installed
  ansible.builtin.package:
    name: rsyslog
    state: present
  when:
    - "'rsyslog' not in ansible_facts.packages"

- name: HARDEN_OS RHEL | Ensure rsyslog Service is enabled and active
  ansible.builtin.systemd:
    name: rsyslog
    enabled: true
    state: started

- name: HARDEN_OS RHEL | Ensure journald is configured to send logs to rsyslog
  ansible.builtin.copy:
    src: "{{ ansible_dir }}/rhel9/templates/etc/systemd/journald.conf.d/journald.conf"
    dest: /etc/systemd/journald.conf
    owner: root
    group: root
    mode: '0640'

- name: HARDEN_OS RHEL | Ensure rsyslog log file creation mode is configured
  ansible.builtin.copy:
    src: "{{ ansible_dir }}/rhel9/templates/etc/rsyslog.conf"
    dest: /etc/rsyslog.conf
    owner: root
    group: root
    mode: '0640'