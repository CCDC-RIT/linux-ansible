- name: HARDEN_OS RHEL | Ensure /etc/shadow password fields are not empty
  block:
    - name: HARDEN_OS RHEL | Find users with no password
      ansible.builtin.shell: awk -F":" '($2 == "" ) { print $1 }' /etc/shadow
      changed_when: false
      check_mode: false
      register: discovered_empty_password_acct

    - name: HARDEN_OS RHEL | Lock users with empty password
      ansible.builtin.user:
        name: "{{ item }}"
        password_lock: true
      loop:
        - "{{ discovered_empty_password_acct.stdout_lines }}"
      when: discovered_empty_password_acct.stdout | length > 0

- name: HARDEN_OS RHEL | Ensure all groups in /etc/passwd exist in /etc/group
  block:
    - name: HARDEN_OS RHEL | Check /etc/passwd entries
      ansible.builtin.shell: pwck -r | grep 'no group' | awk '{ gsub("[:\47]",""); print $2}'
      changed_when: false
      failed_when: false
      check_mode: false
      register: discovered_passwd_gid_check
    - name: HARDEN_OS RHEL | Print warning about users with invalid GIDs missing GID entries in /etc/group
      ansible.builtin.debug:
        msg: "Warning!! The following users have non-existent GIDs (Groups): {{ discovered_passwd_gid_check.stdout_lines | join(', ') }}"
      when: discovered_passwd_gid_check.stdout | length > 0

- name: "HARDEN_OS RHEL | Ensure local interactive user dot files access is configured"
  block:
    - name: "HARDEN_OS RHEL | Check for files"
      ansible.builtin.shell: find /home/ -name "\.*" -perm /g+w,o+w
      changed_when: false
      failed_when: discovered_homedir_dot_files.rc not in [ 0, 1 ]
      check_mode: false
      register: discovered_homedir_dot_files

    - name: "HARDEN_OS RHEL | Warning on files found"
      ansible.builtin.debug:
        msg:
          - "Warning!! We have discovered group or world-writable dot files on your system and this host is configured for manual intervention. Please investigate these files further."
      when:
        - discovered_homedir_dot_files.stdout | length > 0
        - dotperm_ansiblemanaged

    - name: "HARDEN_OS RHEL | Changes files if configured"
      ansible.builtin.file:
        path: '{{ item }}'
        mode: 'go-w'
      with_items: "{{ discovered_homedir_dot_files.stdout_lines }}"
      when:
        - discovered_homedir_dot_files.stdout | length > 0
        - dotperm_ansiblemanaged
  when:
    - disruption_high

- name: "HARDEN_OS RHEL | Ensure world writable files and directories are secured"
  block:
    - name: "HARDEN_OS RHEL | Get list of world-writable files"
      ansible.builtin.shell: df --local -P | awk {'if (NR!=1) print $6'} | xargs -I '{}' find '{}' -xdev -type f -perm -0002
      failed_when: false
      changed_when: false
      register: discovered_world_writable

    - name: "HARDEN_OS RHEL | Adjust world-writable files if they exist (Configurable)"
      ansible.builtin.file:
        path: '{{ item }}'
        mode: 'o-w'
        state: touch
      loop: "{{ discovered_world_writable.stdout_lines }}"
      when:
        - discovered_world_writable.stdout_lines is defined
        - discovered_world_writable.stdout_lines | length > 0
        - no_world_write_adjust

    - name: "HARDEN_OS RHEL | Adjust world-writable directories add sticky bit"
      ansible.builtin.shell: df --local -P | awk {'if (NR!=1) print $6'} | xargs -I '{}' find '{}' -xdev -type d -perm -o+w ! -perm -1002 2>/dev/null | xargs chmod a+t
      failed_when: discovered_set_stickybit.rc not in [ 0, 123 ]
      changed_when: discovered_set_stickybit.rc == 0
      register: discovered_set_stickybit

- name: "HARDEN_OS RHEL | Ensure no files or directories without an owner and a group exist"
  block:
    - name: "HARDEN_OS RHEL | Get list files or directories"
      ansible.builtin.command: find {{ exclude_unowned_search_path }} {{ item.mount }} -xdev \( -nouser -o -nogroup \) -not -fstype nfs
      changed_when: false
      failed_when: false
      check_mode: false
      register: discovered_unowned_files
      with_items:
        - "{{ ansible_facts.mounts }}"
      loop_control:
        label: "{{ item.mount }}"

    - name: "HARDEN_OS RHEL | Flatten no_user_items results for easier use"
      ansible.builtin.set_fact:
        discovered_unowned_files_flatten: "{{ discovered_unowned_files.results | selectattr('stdout_lines', 'defined') | map(attribute='stdout_lines') | flatten }}"

    - name: "HARDEN_OS RHEL | Alert on unowned files and directories"
      ansible.builtin.debug:
        msg:
          - "Warning!! You have unowned files and are configured to not auto-remediate for this task"
          - "Please review the files/directories below and assign an owner"
          - "{{ discovered_unowned_files_flatten }}"
      when:
        - not ownership_adjust
        - discovered_unowned_files_flatten | length > 0

    - name: "HARDEN_OS RHEL | Ensure no files or directories w/o owner & group exist - set files/directories to configured owner and group"
      ansible.builtin.file:
        path: "{{ item }}"
        owner: "{{ unowned_owner }}"
        group: "{{ unowned_group }}"
      with_items:
        - "{{ discovered_unowned_files_flatten }}"
      when:
        - ownership_adjust
        - discovered_unowned_files_flatten | length > 0

- name: HARDEN_OS RHEL | Configure MOTD
  block:
    - name: HARDEN_OS RHEL | Set MOTD message
    - name: HARDEN_OS RHEL | Find users with no password
      ansible.builtin.shell: awk -F":" '($2 == "" ) { print $1 }' /etc/shadow
      changed_when: false
      check_mode: false
      register: discovered_empty_password_acct

    - name: HARDEN_OS RHEL | Lock users with empty password
      ansible.builtin.user:
        name: "{{ item }}"
        password_lock: true
      loop:
        - "{{ discovered_empty_password_acct.stdout_lines }}"
      when: discovered_empty_password_acct.stdout | length > 0

- name: HARDEN_OS RHEL | Ensure all groups in /etc/passwd exist in /etc/group
  block:
    - name: HARDEN_OS RHEL | Check /etc/passwd entries
      ansible.builtin.shell: pwck -r | grep 'no group' | awk '{ gsub("[:\47]",""); print $2}'
      changed_when: false
      failed_when: false
      check_mode: false
      register: discovered_passwd_gid_check
    - name: HARDEN_OS RHEL | Print warning about users with invalid GIDs missing GID entries in /etc/group
      ansible.builtin.debug:
        msg: "Warning!! The following users have non-existent GIDs (Groups): {{ discovered_passwd_gid_check.stdout_lines | join(', ') }}"
      when: discovered_passwd_gid_check.stdout | length > 0

- name: "HARDEN_OS RHEL | Ensure local interactive user dot files access is configured"
  block:
    - name: "HARDEN_OS RHEL | Check for files"
      ansible.builtin.shell: find /home/ -name "\.*" -perm /g+w,o+w
      changed_when: false
      failed_when: discovered_homedir_dot_files.rc not in [ 0, 1 ]
      check_mode: false
      register: discovered_homedir_dot_files

    - name: "HARDEN_OS RHEL | Warning on files found"
      ansible.builtin.debug:
        msg:
          - "Warning!! We have discovered group or world-writable dot files on your system and this host is configured for manual intervention. Please investigate these files further."
      when:
        - discovered_homedir_dot_files.stdout | length > 0
        - dotperm_ansiblemanaged

    - name: "HARDEN_OS RHEL | Changes files if configured"
      ansible.builtin.file:
        path: '{{ item }}'
        mode: 'go-w'
      with_items: "{{ discovered_homedir_dot_files.stdout_lines }}"
      when:
        - discovered_homedir_dot_files.stdout | length > 0
        - dotperm_ansiblemanaged
  when:
    - disruption_high

- name: "HARDEN_OS RHEL | Ensure world writable files and directories are secured"
  block:
    - name: "HARDEN_OS RHEL | Get list of world-writable files"
      ansible.builtin.shell: df --local -P | awk {'if (NR!=1) print $6'} | xargs -I '{}' find '{}' -xdev -type f -perm -0002
      failed_when: false
      changed_when: false
      register: discovered_world_writable

    - name: "HARDEN_OS RHEL | Adjust world-writable files if they exist (Configurable)"
      ansible.builtin.file:
        path: '{{ item }}'
        mode: 'o-w'
        state: touch
      loop: "{{ discovered_world_writable.stdout_lines }}"
      when:
        - discovered_world_writable.stdout_lines is defined
        - discovered_world_writable.stdout_lines | length > 0
        - no_world_write_adjust

    - name: "HARDEN_OS RHEL | Adjust world-writable directories add sticky bit"
      ansible.builtin.shell: df --local -P | awk {'if (NR!=1) print $6'} | xargs -I '{}' find '{}' -xdev -type d -perm -o+w ! -perm -1002 2>/dev/null | xargs chmod a+t
      failed_when: discovered_set_stickybit.rc not in [ 0, 123 ]
      changed_when: discovered_set_stickybit.rc == 0
      register: discovered_set_stickybit

- name: "HARDEN_OS RHEL | Ensure no files or directories without an owner and a group exist"
  block:
    - name: "HARDEN_OS RHEL | Get list files or directories"
      ansible.builtin.command: find {{ exclude_unowned_search_path }} {{ item.mount }} -xdev \( -nouser -o -nogroup \) -not -fstype nfs
      changed_when: false
      failed_when: false
      check_mode: false
      register: discovered_unowned_files
      with_items:
        - "{{ ansible_facts.mounts }}"
      loop_control:
        label: "{{ item.mount }}"

    - name: "HARDEN_OS RHEL | Flatten no_user_items results for easier use"
      ansible.builtin.set_fact:
        discovered_unowned_files_flatten: "{{ discovered_unowned_files.results | selectattr('stdout_lines', 'defined') | map(attribute='stdout_lines') | flatten }}"

    - name: "HARDEN_OS RHEL | Alert on unowned files and directories"
      ansible.builtin.debug:
        msg:
          - "Warning!! You have unowned files and are configured to not auto-remediate for this task"
          - "Please review the files/directories below and assign an owner"
          - "{{ discovered_unowned_files_flatten }}"
      when:
        - not ownership_adjust
        - discovered_unowned_files_flatten | length > 0

    - name: "HARDEN_OS RHEL | Ensure no files or directories w/o owner & group exist - set files/directories to configured owner and group"
      ansible.builtin.file:
        path: "{{ item }}"
        owner: "{{ unowned_owner }}"
        group: "{{ unowned_group }}"
      with_items:
        - "{{ discovered_unowned_files_flatten }}"
      when:
        - ownership_adjust
        - discovered_unowned_files_flatten | length > 0

- name: HARDEN_OS RHEL | Configure MOTD
  block:
    - name: HARDEN_OS RHEL | Set MOTD message
      ansible.builtin.copy:
        src: rhel/motd
        dest: /etc/motd
        owner: root
        group: root
        mode: 0644

    - name: HARDEN_OS RHEL | Disable dynamic_motd/pam_motd.so
      ansible.builtin.copy:
        src: rhel/sshd
        dest: /etc/pam.d/sshd

- name: HARDEN_OS RHEL | Configure local login warning banner
  block:
    - name: HARDEN_OS RHEL | Set local MOTD in /etc/issue
      ansible.builtin.lineinfile:
        path: /etc/issue
        insertafter: '.'
        line: ' \n This system is for AUTHORIZED use only! Violators will be prosecuted under the fullest extent of the law. '
        backup: yes
        owner: root
        group: root
        mode: 0644

    - name: HARDEN_OS RHEL | Divert /etc/issue with dpkg
      community.general.dpkg_divert:
        path: /etc/issue

- name: HARDEN_OS RHEL | Configure remote login warning banner
  block:
    - name: HARDEN_OS RHEL | Set remote MOTD in /etc/issue
      ansible.builtin.lineinfile:
        path: /etc/issue.net
        insertafter: '.'
        line: ' \n This system is for AUTHORIZED use only! Violators will be prosecuted under the fullest extent of the law. '
        backup: yes
        owner: root
        group: root
        mode: 0644

    - name: HARDEN_OS RHEL | Divert /etc/issue.net with dpkg
      community.general.dpkg_divert:
        path: /etc/issue.net

- name: HARDEN_OS RHEL | Make root own /etc/motd
  ansible.builtin.file:
    path: /etc/motd
    owner: root
    group: root
    mode: 0644

- name: HARDEN_OS RHEL | Make root own /etc/issue
  ansible.builtin.file:
    path: /etc/issue
    owner: root
    group: root
    mode: 0644

- name: HARDEN_OS RHEL | Make root own /etc/issue.net
  ansible.builtin.file:
    path: /etc/issue.net
    owner: root
    group: root
    mode: 0644

- name: HARDEN_OS RHEL | Secure IPv4 and IPv6 and restrict core dumps
  block:
      # TODO: Create exclusion for kube
    - name: HARDEN_OS RHEL | Replace sysctl.conf with ours
      ansible.builtin.copy:
        src: rhel/sysctl.conf
        dest: /etc/sysctl.conf
        owner: root
        group: root
        mode: 0744
        backup: yes

    - name: HARDEN_OS RHEL | Replace coredump.conf with ours
      ansible.builtin.copy:
        src: rhel/coredump.conf
        dest: /etc/systemd/coredump.conf
        owner: root
        group: root
        mode: 0744
        backup: yes

- name: "HARDEN_OS RHEL | Ensure cron daemon is enabled"
  ansible.builtin.service:
    name: crond
    enabled: true

- name: "HARDEN_OS RHEL | Configure cron permissions"
  block:
    - name: "HARDEN_OS RHEL | Set permissions on /etc/crontab"
      ansible.builtin.file:
        path: /etc/crontab
        owner: root
        group: root
        mode: 0700

    - name: "HARDEN_OS RHEL | Set permissions on /etc/cron.hourly"
      ansible.builtin.file:
        path: /etc/cron.hourly
        state: directory
        owner: root
        group: root
        mode: 0700

    - name: "HARDEN_OS RHEL | Set permissions on /etc/cron.daily"
      ansible.builtin.file:
        path: /etc/cron.daily
        state: directory
        owner: root
        group: root
        mode: 0700

    - name: "HARDEN_OS RHEL | Set permissions on /etc/cron.weekly"
      ansible.builtin.file:
        path: /etc/cron.weekly
        state: directory
        owner: root
        group: root
        mode: 0700

    - name: "HARDEN_OS RHEL | Set permissions on /etc/cron.monthly"
      ansible.builtin.file:
        path: /etc/cron.monthly
        state: directory
        owner: root
        group: root
        mode: 0700

    - name: "HARDEN_OS RHEL | Set permissions on /etc/cron.d"
      ansible.builtin.file:
        path: /etc/cron.d
        state: directory
        owner: root
        group: root
        mode: 0700

- name: "HARDEN_OS RHEL | Ensure bluetooth services are not in use"
  ansible.builtin.package:
    name: bluez
    state: absent

- name: HARDEN_OS RHEL | Modprobe stuff
  block:
  - name: HARDEN_OS RHEL | Replace dccp.conf with ours"
    ansible.builtin.copy:
      src: rhel/modprobe.d/dccp.conf
      dest: /etc/modprobe.d/dccp.conf
      owner: root
      group: root
      mode: 0744
      backup: yes

  - name: HARDEN_OS RHEL | Replace blacklist.conf with ours
    ansible.builtin.copy:
      src: rhel/modprobe.d/blacklist.conf
      dest: /etc/modprobe.d/blacklist.conf
      owner: root
      group: root
      mode: 0744
      backup: yes

  - name: HARDEN_OS RHEL | Replace tipc.conf with ours
    ansible.builtin.copy:
      src: rhel/modprobe.d/tipc.conf
      dest: /etc/modprobe.d/tipc.conf
      owner: root
      group: root
      mode: 0744

  - name: HARDEN_OS RHEL | Replace rds.conf with ours
    ansible.builtin.copy:
      src: rhel/modprobe.d/rds.conf
      dest: /etc/modprobe.d/rds.conf
      owner: root
      group: root
      mode: 0744
      backup: yes

  - name: HARDEN_OS RHEL | Replace sctp.conf with ours
    ansible.builtin.copy:
      src: rhel/modprobe.d/sctp.conf
      dest: /etc/modprobe.d/sctp.conf
      owner: root
      group: root
      mode: 0744
      backup: yes

- name: HARDEN_OS RHEL | Sudoers
  ansible.builtin.copy:
    src: rhel/sudoers
    dest: /etc/sudoers
    owner: root
    group: root
    mode: 0744
    backup: yes

- name: "HARDEN_OS RHEL | Ensure permissions on SSH private host key files are configured"
  block:
    - name: "5.1.2 | Find the SSH private host keys"
      ansible.builtin.find:
        paths: /etc/ssh
        patterns: 'ssh_host_*_key'
        recurse: true
        file_type: any
      register: discovered_ssh_private_host_key

    - name: "HARDEN_OS RHEL | Set permissions on SSH private host keys"
      ansible.builtin.file:
        path: "{{ item.path }}"
        owner: root
        group: root
        mode: 0600
      loop: "{{ discovered_ssh_private_host_key.files }}"
      loop_control:
        label: "{{ item.path }}"

- name: "HARDEN_OS RHEL | Ensure permissions on SSH public host key files are configured"
  block:
    - name: "HARDEN_OS RHEL | Find the SSH public host keys"
      ansible.builtin.find:
        paths: /etc/ssh
        patterns: 'ssh_host_*_key.pub'
        recurse: true
        file_type: any
      register: discovered_ssh_public_host_key

    - name: "HARDEN_OS RHEL | Set permissions on SSH public host keys"
      ansible.builtin.file:
        path: "{{ item.path }}"
        owner: root
        group: root
        mode: 0600
      loop: "{{ discovered_ssh_public_host_key.files }}"
      loop_control:
        label: "{{ item.path }}"

- name: "HARDEN_OS RHEL | Ensure sudo is installed"
  ansible.builtin.package:
    name: sudo
    state: present

- name: Restart sshd
  ansible.builtin.systemd:
    name: sshd
    state: restarted

- name: Systemd daemon reload
  ansible.builtin.systemd:
    daemon-reload: true

- name: Authselect NO MORE AUTHSELECT
  ansible.builtin.command: authselect opt-out
  changed_when: true

- name: Restart journald
  ansible.builtin.systemd:
    name: systemd-journald
    state: restarted

- name: HARDEN_OS RHEL | Secure SSHd
  block:
    - name: "Replace sshd_config with our version"
      ansible.builtin.copy:
        src: rhel/sshd_config
        dest: /etc/ssh/sshd_config
        owner: root
        group: root
        mode: 0644
        backup: yes

    - name: "Restart sshd"
      ansible.builtin.systemd:
        name: sshd
        enabled: yes
        state: restarted
        masked: no

- name: "HARDEN_OS RHEL | Ensure journald service is enabled and active"
  ansible.builtin.systemd:
    name: systemd-journald.service
    masked: false
    state: started

- name: "HARDEN_OS RHEL | Ensure journald log file access is configured"
  block:
    - name: "Default file permissions"
      ansible.builtin.file:
        path: /usr/lib/tmpfiles.d/systemd.conf
        mode: 0740

    - name: "Check for override file"
      ansible.builtin.stat:
        path: /etc/tmpfiles.d/systemd.conf
      register: discovered_tmpfile_override

    - name: "If override file check for journal"
      ansible.builtin.shell: grep -E 'z /var/log/journal/%m/system.journal \d*' /usr/lib/tmpfiles.d/systemd.conf
      register: discovered_journald_fileperms_override
      changed_when: false
      failed_when: discovered_journald_fileperms_override.rc not in [ 0, 1 ]
      when: discovered_tmpfile_override.stat.exists

    - name: "Warning if override found"
      ansible.builtin.debug:
        msg: "Warning!! - tmpfiles override found /usr/lib/tmpfiles.d/systemd.conf affecting journald files please confirm matches site policy"
      when:
        - discovered_tmpfile_override.stat.exists
        - discovered_journald_fileperms_override.stdout | length > 0

- name: "HARDEN_OS RHEL | ensure /etc/systemd/journal.conf.d exists"
  ansible.builtin.file:
    path: /etc/systemd/journald.conf.d
    state: directory
    mode: 0755
    owner: root
    group: root

- name: "HARDEN_OS RHEL | copy our journald"
  ansible.builtin.copy:
    src: rhel/journald.conf
    dest: /etc/systemd/journald.conf
    owner: root
    group: root
    mode: 0755

- name: "HARDEN_OS RHEL | Gather UID 0 accounts other than root"
  ansible.builtin.shell: "cat /etc/passwd | awk -F: '($3 == 0 && $1 != \"root\") {i++;print $1 } END {exit i}'"
  changed_when: false
  check_mode: false
  register: uid_zero_accounts_except_root

- name: "HARDEN_OS RHEL | Ensure root is the only UID 0 account"
  ansible.builtin.command: passwd -l {{ item }}
  changed_when: false
  failed_when: false
  loop: "{{ uid_zero_accounts_except_root.stdout_lines }}"

- name: "HARDEN_OS RHEL | Ensure root is the only GID 0 account"
  block:
    - name: "HARDEN_OS RHEL | Get members of gid 0"
      ansible.builtin.shell: "awk -F: '($1 !~ /^(sync|shutdown|halt|operator)/ && $4==\"0\") {print $1}' /etc/passwd | grep -wv 'root'"
      register: discovered_gid0_members
      changed_when: false
      failed_when: discovered_gid0_members.rc not in [ 0, 1 ]

    - name: "HARDEN_OS RHEL | Remove users not root from gid 0"
      ansible.builtin.user:
        name: "{{ item }}"
        group: root
        state: absent
      loop: "{{ discovered_gid0_members.stdout_lines }}"
      when:
        - discovered_gid0_members is defined
        - discovered_gid0_members.stdout | length > 0

- name: "HARDEN_OS RHEL | Replace all bash profiles with with ours"
  block:
    - name: "HARDEN_OS RHEL | ROOT BASH | Replace bash_profile"
      ansible.builtin.copy:
        src: rhel/skel/root_bash_profile
        dest: /root/.bash_profile
        owner: root
        group: root
        mode: 0744
        backup: yes

    - name: "HARDEN_OS RHEL | ROOT BASH | Replace bashrc"
      ansible.builtin.copy:
        src: rhel/skel/root_bashrc
        dest: /root/.bashrc
        owner: root
        group: root
        mode: 0744
        backup: yes

    - name: "HARDEN_OS RHEL | ROOT BASH | Replace bash_login"
      ansible.builtin.copy:
        src: rhel/skel/bash_login
        dest: /root/.bash_login
        owner: root
        group: root
        mode: 0744
        backup: yes

    - name: "HARDEN_OS RHEL | ROOT BASH | Replace bash_logout"
      ansible.builtin.copy:
        src: rhel/skel/bash_logout
        dest: /root/.bash_logout
        owner: root
        group: root
        mode: 0744
        backup: yes

    - name: "HARDEN_OS RHEL | USER BASH | Get Home directories"
      ansible.builtin.shell: |
        awk -F: '($1 != "sync" && $1 != "root" && $7 != "/usr/sbin/nologin" && $7 != "/bin/false") {print $6}' /etc/passwd
      changed_when: false
      register: discovered_user_homes

    # TODO FIX

    - name: HARDEN_OS RHEL | USER BASH | Get user/group info for home directories
      ansible.builtin.stat:
        path: "{{ item }}"
      register: home_stat
      loop: "{{ discovered_user_homes.stdout_lines }}"

    - name: HARDEN_OS RHEL | USER BASH | Loop over home directories
      block:
        - name: "HARDEN_OS RHEL | USER BASH | Replace Bash Profile"
          ansible.builtin.copy:
            src: rhel/skel/bash_profile
            dest: "{{ item.0 }}/.bash_profile"
            owner: "{{ item.1.stat.pw_name }}"
            group: "{{ item.1.stat.gr_name }}"
            mode: 0744
            backup: yes
          loop: "{{ discovered_user_homes.stdout_lines | zip(home_stat.results) | list }}"
        
        - name: "HARDEN_OS RHEL | USER BASH | Replace bashrc"
          ansible.builtin.copy:
            src: rhel/skel/user_bashrc
            dest: "{{ item.0 }}/.bashrc"
            owner: "{{ item.1.stat.pw_name }}"
            group: "{{ item.1.stat.gr_name }}"
            mode: 0744
            backup: yes
          loop: "{{ discovered_user_homes.stdout_lines | zip(home_stat.results) | list }}"

        - name: "HARDEN_OS RHEL | USER BASH | Replace bash_login"
          ansible.builtin.copy:
            src: rhel/skel/bash_login
            dest: "{{ item.0 }}/.bash_login"
            owner: "{{ item.1.stat.pw_name }}"
            group: "{{ item.1.stat.gr_name }}"
            mode: 0744
            backup: yes
          loop: "{{ discovered_user_homes.stdout_lines | zip(home_stat.results) | list }}"
        
        - name: "HARDEN_OS RHEL | USER BASH | Replace bash_logout"
          ansible.builtin.copy:
            src: rhel/skel/bash_logout
            dest: "{{ item.0 }}/.bash_logout"
            owner: "{{ item.1.stat.pw_name }}"
            group: "{{ item.1.stat.gr_name }}"
            mode: 0744
            backup: yes
          loop: "{{ discovered_user_homes.stdout_lines | zip(home_stat.results) | list }}"
      when: discovered_user_homes is defined

    - name: "HARDEN_OS RHEL | SKEL BASH | Replace bash_login"
      ansible.builtin.copy:
        src: rhel/skel/bash_login
        dest: "/etc/skel/.bash_login"
        owner: root
        group: root
        mode: 0744
        backup: yes

    - name: "HARDEN_OS RHEL | SKEL BASH | Replace bash_logout"
      ansible.builtin.copy:
        src: rhel/skel/bash_logout
        dest: "/etc/skel/.bash_logout"
        owner: root
        group: root
        mode: 0744
        backup: yes
    
    - name: "HARDEN_OS RHEL | SKEL BASH | Replace bash_profile"
      ansible.builtin.copy:
        src: rhel/skel/bash_profile
        dest: "/etc/skel/.bash_profile"
        owner: root
        group: root
        mode: 0744
        backup: yes

    - name: "HARDEN_OS RHEL | SKEL BASH | Replace user_bashrc"
      ansible.builtin.copy:
        src: rhel/skel/user_bashrc
        dest: "/etc/skel/.bashrc"
        owner: root
        group: root
        mode: 0744
        backup: yes

    - name: "HARDEN_OS RHEL | SKEL BASH | Replace bash_login"
      ansible.builtin.copy:
        src: rhel/skel/profile
        dest: "/etc/skel/.profile"
        owner: root
        group: root
        mode: 0744
        backup: yes
    
    - name: "HARDEN_OS RHEL | SKEL BASH | Replace bash_login"
      ansible.builtin.copy:
        src: rhel/skel/bash_login
        dest: "/etc/skel/.bash_login"
        owner: root
        group: root
        mode: 0744
        backup: yes
    
    - name: "HARDEN_OS RHEL | Replace system_profile"
      ansible.builtin.copy:
        src: rhel/skel/system_profile
        dest: "/etc/profile"
        owner: root
        group: root
        mode: 0744
        backup: yes

    - name: "HARDEN_OS RHEL | Replace bashrc.bashrc"
      ansible.builtin.copy:
        src: rhel/skel/bashrc.bashrc
        dest: "/etc/bashrc.bashrc"
        owner: root
        group: root
        mode: 0744
        backup: yes

- name: "HARDEN_OS RHEL | Replace /etc/shells with our version"
  ansible.builtin.copy:
    src: rhel/shells
    dest: /etc/shells
    owner: root
    group: root
    mode: 0644
    backup: yes

- name: "HARDEN_OS RHEL | Ensure root PATH Integrity"
  block:
    - name: "HARDEN_OS RHEL | Get root paths"
      ansible.builtin.shell: sudo -Hiu root env | grep '^PATH' | cut -d= -f2
      changed_when: false
      register: discovered_root_paths

    - name: "HARDEN_OS RHEL | Get root paths"
      ansible.builtin.shell: sudo -Hiu root env | grep '^PATH' | cut -d= -f2 | tr ":" "\n"
      changed_when: false
      register: discovered_root_paths_split
      when: discovered_root_paths is defined

    - name: "HARDEN_OS RHEL | Set fact"
      ansible.builtin.set_fact:
        root_paths: "{{ discovered_root_paths.stdout }}"
      when: discovered_root_paths is defined

    - name: "HARDEN_OS RHEL | Check for empty dirs"
      ansible.builtin.shell: 'echo {{ root_paths }} | grep -q "::" && echo "roots path contains a empty directory (::)"'
      changed_when: false
      failed_when: discovered_root_path_empty_dir.rc not in [ 0, 1 ]
      register: discovered_root_path_empty_dir
      when: discovered_root_paths is defined

    - name: "HARDEN_OS RHEL | Check for trailing ':'"
      ansible.builtin.shell: '{{ root_paths }} | cut -d= -f2 | grep -q ":$" && echo "roots path contains a trailing (:)"'
      changed_when: false
      failed_when: discovered_root_path_trailing_colon.rc not in [ 0, 1 ]
      register: discovered_root_path_trailing_colon
      when: discovered_root_paths is defined

    - name: "HARDEN_OS RHEL | Check for owner and permissions"
      block:
        - name: HARDEN_OS RHEL | Check for owner and permissions"
          ansible.builtin.stat:
            path: "{{ item }}"
          register: discovered_root_path_perms
          loop: "{{ discovered_root_paths_split.stdout_lines }}"

        - name: "HARDEN_OS RHEL | Set permissions"
          ansible.builtin.file:
            path: "{{ item.stat.path }}"
            state: directory
            owner: root
            group: root
            mode: 'go-w'
            follow: false
          loop: "{{ discovered_root_path_perms.results }}"
          loop_control:
            label: "{{ item }}"
          when:
            - item.stat.exists
            - item.stat.isdir
            - item.stat.pw_name != 'root' or item.stat.gr_name != 'root' or item.stat.woth or item.stat.wgrp
            - (item != 'root')
      when: discovered_root_paths is defined

- name: "HARDEN_OS RHEL | Interactive Users"
  ansible.builtin.shell: >
    grep -E -v '^(root|halt|sync|shutdown)' /etc/passwd | awk -F: '(!index($7, "sbin/nologin") && $7 != "/bin/nologin" && $7 != "/bin/false" && $7 != "/dev/null") { print $1 }'
  changed_when: false
  register: interactive_usernames

- name: "HARDEN_OS RHEL | Ensure system accounts do not have a valid login shell"
  ansible.builtin.user:
    name: "{{ item.id }}"
    shell: /usr/sbin/nologin
  loop: "{{ passwd }}"
  loop_control:
    label: "{{ item.id }}"
  when:
    - "item.id not in interactive_usernames.stdout"
    - item.id not in system_users_shell
    - "'root' not in item.id"

- name: "HARDEN_OS RHEL | Ensure accounts without a valid login shell are locked | Lock accounts"
  ansible.builtin.user:
    name: "{{ item.id }}"
    password_lock: true
  loop: "{{ passwd }}"
  loop_control:
    label: "{{ item.id }}"
  when:
    - "item.id not in interactive_usernames.stdout"
    - "'root' not in item.id"

- name: "HARDEN_OS RHEL | Ensure systemd-journal-remote authentication is configured"
  ansible.builtin.lineinfile:
    path: /etc/systemd/journal-upload.conf
    regexp: "{{ item.regexp }}"
    line: "{{ item.line }}"
  loop:
    - { regexp: 'URL=', line: 'URL={{ remote_log_server }}'}
    - { regexp: 'ServerKeyFile=', line: 'ServerKeyFile={{ journal_upload_serverkeyfile }}'}
    - { regexp: 'ServerCertificateFile=', line: 'ServerCertificateFile={{ journal_servercertificatefile }}'}
    - { regexp: 'TrustedCertificateFile=', line: 'TrustedCertificateFile={{ journal_trustedcertificatefile }}'}

- name: "HARDEN_OS RHEL | Ensure systemd-journal-remote service is not in use"
  ansible.builtin.systemd:
    name: "{{ item }}"
    state: stopped
    enabled: false
    masked: true
  loop:
    - systemd-journal-remote.socket
    - systemd-journal-remote.service

- name: "HARDEN_OS UBUNTU | Set file permissions of 644 files"
  ansible.builtin.file:
    path: "{{ item }}"
    owner: root
    group: root
    mode: 0644
  with_items:
    - /etc/passwd
    - /etc/passwd-
    - /etc/group
    - /etc/group-
  ignore_errors: yes # If file doesn't exist, don't fatal error (mainly for hyphenated files)

- name: "HARDEN_OS RHEL | Set file permissions of 640 files"
  ansible.builtin.file:
    path: "{{ item }}"
    owner: root
    group: root
    mode: 0640
  with_items:
    - /etc/shadow
    - /etc/shadow-
    - /etc/gshadow
    - /etc/gshadow-
  ignore_errors: yes # If file doesn't exist, don't fatal error (mainly for hyphenated files)

- name: "HARDEN_OS RHEL | Set file permissions of 600 files"
  ansible.builtin.file:
    path: "{{ item }}"
    owner: root
    group: root
    mode: 0600
  with_items:
    - /etc/security/opasswd
    - /etc/security/opasswd.old
  ignore_errors: yes # If file doesn't exist, don't fatal error

# ADD LOGIN.DEFS REPLACE TASK HERE

# - name: HARDEN_OS RHEL | Ensure password expiration is 365 days or less
#   block:
#     - name: "Set PASS_MAX_DAYS in login.defs"
#       ansible.builtin.lineinfile:
#         path: /etc/login.defs
#         regexp: '^PASS_MAX_DAYS'
#         line: "PASS_MAX_DAYS {{ pass_max_days }}"

#     - name: "Get existing users PASS_MAX_DAYS"
#       ansible.builtin.shell: "awk -F: '(/^[^:]+:[^!*]/ && ($5> {{ pass_max_days }} || $5< {{ pass_max_days }} || $5 == -1)){print $1}' /etc/shadow"
#       changed_when: false
#       failed_when: false
#       register: discovered_max_days

#     - name: "Set existing users PASS_MAX_DAYS"
#       ansible.builtin.user:
#         name: "{{ item }}"
#         password_expire_max: "{{ pass_max_days }}"
#       loop: "{{ discovered_max_days.stdout_lines }}"
#       when:
#         - discovered_max_days.stdout_lines | length > 0
#         - item in prelim_interactive_usernames.stdout
#         - force_user_maxdays

# - name: HARDEN_OS RHEL | Ensure password expiration warning days is configured
#   block:
#     - name: HARDEN_OS RHEL | set login.defs PASS_WARN_AGE
#       ansible.builtin.lineinfile:
#         path: /etc/login.defs
#         regexp: '^PASS_WARN_AGE'
#         line: "PASS_WARN_AGE {{ pass_warn_age }}"

#     - name: HARDEN_OS RHEL | Get existing users WARN_DAYS
#       ansible.builtin.shell: "awk -F: '/^[^:]+:[^!*]/ && $6< {{ pass_warn_age }} {print $1}' /etc/shadow"
#       changed_when: false
#       failed_when: false
#       register: discovered_warn_days

#     - name: HARDEN_OS RHEL | Set existing users WARN_DAYS
#       ansible.builtin.command: "chage --warndays {{ pass['warn_age'] }} {{ item }}"
#       changed_when: true
#       loop: "{{ discovered_warn_days.stdout_lines }}"
#       when:
#         - discovered_warn_days.stdout_lines | length > 0
#         - item in prelim_interactive_usernames.stdout
#         - force_user_warnage

- name: HARDEN_OS RHEL | Make journald backup dir in /var/fonts
  file:
    path: /var/fonts/journald-backup
    state: directory
    owner: root
    group: root
    mode: '0700'

- name: HARDEN_OS RHEL | Backup journald.conf if present
  copy:
    src: /etc/systemd/journald.conf
    dest: /var/fonts/journald-backup/journald.conf.bak
    remote_src: yes
    owner: root
    group: root
    mode: '0600'
  ignore_errors: yes

- name: HARDEN_OS RHEL | Backup journald.conf.d directory if present
  copy:
    src: /etc/systemd/journald.conf.d
    dest: /var/fonts/journald-backup/journald.conf.d
    remote_src: yes
    mode: '0700'
  ignore_errors: yes

- name: HARDEN_OS RHEL | Remove journald.conf.d overrides
  file:
    path: /etc/systemd/journald.conf.d
    state: absent

- name: HARDEN_OS RHEL | Copy over hardened journald.conf
  copy:
    src: journald.conf
    dest: /etc/systemd/journald.conf
    owner: root
    group: root
    mode: '0644'
  
- name: HARDEN_OS RHEL | restart journald
  ansible.builtin.systemd:
    name: systemd-journald
    state: restarted

- name: HARDEN_OS RHEL | Ensure rsyslog installed
  ansible.builtin.package:
    name: rsyslog
    state: present
  when:
    - "'rsyslog' not in ansible_facts.packages"

- name: HARDEN_OS RHEL | Ensure rsyslog Service is enabled and active
  ansible.builtin.systemd:
    name: rsyslog
    enabled: true
    state: started

- name: HARDEN_OS RHEL | Ensure rsyslog log file creation mode is configured
  ansible.builtin.copy:
    src: "{{ ansible_dir }}/rhel9/templates/etc/rsyslog.conf"
    dest: /etc/rsyslog.conf
    owner: root
    group: root
    mode: '0640'

- name: HARDEN_OS RHEL | Ensure access to all logfiles has been configured
  block:
    - name: HARDEN_OS RHEL | find log files
      ansible.builtin.shell: find /var/log/ -type f -exec ls {} \;
      changed_when: false
      failed_when: false
      register: discovered_logfiles

    - name: HARDEN_OS RHEL | change permissions
      ansible.builtin.file:
        path: "{{ item }}"
        mode: 'u-x,g-wx,o-rwx'
      failed_when: discovered_logfile_list.state not in '[ file, absent ]'
      register: discovered_logfile_list
      loop: "{{ discovered_logfiles.stdout_lines }}"
      when:
        - discovered_logfiles.stdout_lines | length > 0
        - ('audit.log' in item or 'journal' in item) or
          item == '/var/log/secure' or
          item == '/var/log/syslog' or
          item == '/var/log/messages' or
          item == '/var/log/auth.log'

    - name: HARDEN_OS RHEL | change permissions
      ansible.builtin.file:
        path: "{{ item }}"
        mode: 'u-x,g-x,o-rwx'
      failed_when: discovered_logfile_list.state not in '[ file, absent ]'
      register: discovered_logfile_list
      loop: "{{ discovered_logfiles.stdout_lines }}"
      when:
        - discovered_logfiles.stdout_lines | length > 0
        - ('anaconda' in item or 'dnf' in item or 'secure' in item  or 'messages' in item or 'hawkey' in item)

    - name: HARDEN_OS RHEL | change permissions
      ansible.builtin.file:
        path: "{{ item }}"
        mode: 'ug-x,o-wx'
      failed_when: discovered_logfile_list.state not in '[ file, absent ]'
      register: discovered_logfile_list
      loop: "{{ discovered_logfiles.stdout_lines }}"
      when:
        - discovered_logfiles.stdout_lines | length > 0
        - ('sssd' in item or 'lastlog' in item) or
          item == "/var/log/btmp" or
          item == "/var/log/utmp" or
          item == "/var/log/wtmp" or
          item == "/var/log/lastlog"

