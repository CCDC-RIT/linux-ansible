---
- task: Install Common Packages
  apt:
    name: "{{ item }}"
    state: present
  with_items:
    - "vim"
    - "curl"
    - "iptables"
    - "git"
    - "python3-pip"
  
- task: Make backup directory
  file:
    path: "{{ backup_dir }}"
    state: directory
    owner: root
    group: root
    mode: '0700'

- name: Install and start Wireshark capture
  hosts: all
  become: yes
  vars:
    interface: "" # FILL THIS IN BEFORE RUNNING
  tasks:
    - name: Install Wireshark
      package:
        name: "{{ item }}"
        state: present
      loop:
        - wireshark
        - tshark

    - name: Add user to wireshark group
      user:
        name: "{{ ansible_user }}"
        group: wireshark
        append: yes
      when: ansible_distribution == "Ubuntu" or ansible_distribution == "Debian"

    - name: Set capabilities on dumpcap
      command: setcap cap_net_raw,cap_net_admin=eip /usr/bin/dumpcap
      args:
        warn: false

    - name: Start a Wireshark capture
      command: tshark -i {{ interface }} -w /tmp/capture.pcap -f "tcp" &
      async: 5
      poll: 0

    - name: Wait for tshark to start
      pause:
        seconds: 2

- name: Check open ports and services with netstat
  hosts: all
  become: true
  tasks:
    - name: List all open ports and associated services using netstat
      ansible.builtin.command:
        cmd: netstat -tuln
      register: netstat_output

    - name: Display netstat output
      ansible.builtin.debug:
        var: netstat_output.stdout_lines