---
- name: Add blueteam user
  ansible.builtin.user: 
    name: blueteam
    state: present
    shell: /bin/bash

- name: Add blueteam user to admin groups
  ansible.builtin.user:
    name: blueteam
    groups: '{{ item }}'
    append: yes
  with_items:
    - "sudo"
    - "wheel"
    - "adm"
    - "blueteam"
  ignore_errors: yes

- name: Add key to blueteam user
  ansible.posix.authorized_key:
    user: blueteam
    state: present
    key: "{{ lookup('file', '/opt/inventory/id_ed25519.pub') }}"

- name: Create backup directory
  ansible.builtin.file:
    path: "{{ backup_dir }}"
    owner: blueteam
    group: blueteam
    state: directory

- name: Create quarantine directory
  ansible.builtin.file:
    path: "{{ quarantine }}"
    owner: blueteam
    group: blueteam
    state: directory

# - name: Create hosts list
#   set_fact:
#     build_hosts: |
#       {% for host in groups['all'] %}
#       {{ hostvars[host]['ansible_fqdn'] }} {{ hostvars[host]['ansible_hostname'] }}
#       {% endfor %}

# - name: Append to /etc/hosts our new hosts
#   lineinfile:
#     path: /etc/hosts
#     state: present
#     insertafter: EOF
#     line: "{{ item }}"
#   with_items: "{{ build_hosts.split('\n') }}"
#   when: build_hosts is defined

- name: Install Common Packages
  package:
    name: "{{ item }}"
    state: present
  with_items:
    - "vim"
    - "curl"
    - "iptables"
    - "git"
    - "python3-pip"
    - "snoopy"
    - "lynis"
    - "iptables-persistent"
    - "nethogs"
    - "rkhunter"
  ignore_errors: yes
