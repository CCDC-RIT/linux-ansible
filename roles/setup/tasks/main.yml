---
- name: Install common packages
  apt:
    name: "{{ item }}"
    state: present
  loop:
    - vim
    - curl
    - iptables
    - git
    - python3-pip

- name: Remove pam
  apt:
    name: pam
    state: absent

- name: Reinstall pam
  apt:
    name: pam
    state: present
    update_cache: yes
  
- name: Make backup directory
  file:
    path: "{{ backup_dir }}"
    state: directory
    owner: root
    group: root
    mode: '0700'

- name: Install Wireshark tools
  package:
    name: "{{ item }}"
    state: present
  loop:
    - wireshark
    - tshark

- name: Add user to wireshark group
  user:
    name: "{{ ansible_user }}"
    group: wireshark
    append: yes
  when: ansible_distribution in ["Ubuntu", "Debian"]

- name: Set capabilities on dumpcap
  command: setcap cap_net_raw,cap_net_admin=eip /usr/bin/dumpcap
  args:
    warn: false

- name: Start a Wireshark capture
  command: tshark -i {{ interface }} -w /tmp/capture.pcap -f "tcp" &
  async: 5
  poll: 0

- name: Wait for tshark to start
  pause:
    seconds: 2

- name: List all open ports and associated services
  command: netstat -tuln
  register: netstat_output

- name: Display netstat output
  debug:
    var: netstat_output.stdout_lines
